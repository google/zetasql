# This file is solely to cover the tricky cases of logging name references which
# would be shadowed by a lateral column reference if
# FEATURE_LATERAL_COLUMN_REFERENCES is enabled, without actually turning it on.
# The actual test coverage for the feature itself is in
# `lateral_column_alias.test`.

[default language_features=MAXIMUM,-LATERAL_COLUMN_REFERENCES]
# Ensure that the retry then matching to a group-by expression is not causing
# a missed log entry.
SELECT
  (SELECT AS STRUCT
    s.*,
    STRUCT(s.x + rand() AS a, s.y + rand() AS b) AS s,  # Changes names and types
    ANY_VALUE(s) AS s2,
    s2.a,
    SUM(s2.a) OVER() AS w
   FROM (SELECT 1 AS x, 2 AS y) AS inner_t
   WHERE s.x < 0
   GROUP BY outer_t.s, outer_t.s2, s, x, y
  )
FROM
  (SELECT
    STRUCT(1 AS x, 2 AS y) AS s,
    STRUCT(10 AS a, 20 AS b) AS s2
  ) AS outer_t
--
QueryStmt
+-output_column_list=
| +-$query.$col1#16 AS `$col1` [STRUCT<x INT64, y INT64, s STRUCT<a DOUBLE, b DOUBLE>, s2 STRUCT<x INT64, y INT64>, a INT64, w INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#16]
    +-expr_list=
    | +-$col1#16 :=
    |   +-SubqueryExpr
    |     +-type=STRUCT<x INT64, y INT64, s STRUCT<a DOUBLE, b DOUBLE>, s2 STRUCT<x INT64, y INT64>, a INT64, w INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=outer_t.s#1)
    |     | +-ColumnRef(type=STRUCT<a INT64, b INT64>, column=outer_t.s2#2)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$make_struct.$struct#15]
    |         +-expr_list=
    |         | +-$struct#15 :=
    |         |   +-MakeStruct
    |         |     +-type=STRUCT<x INT64, y INT64, s STRUCT<a DOUBLE, b DOUBLE>, s2 STRUCT<x INT64, y INT64>, a INT64, w INT64>
    |         |     +-field_list=
    |         |       +-ColumnRef(type=INT64, column=$groupby.x#11)
    |         |       +-ColumnRef(type=INT64, column=$groupby.y#12)
    |         |       +-ColumnRef(type=STRUCT<a DOUBLE, b DOUBLE>, column=$groupby.s#10)
    |         |       +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=$aggregate.s2#6)
    |         |       +-ColumnRef(type=INT64, column=$expr_subquery.a#13)
    |         |       +-ColumnRef(type=INT64, column=$analytic.w#14)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$groupby.x#11, $groupby.y#12, $groupby.s#10, $aggregate.s2#6, $expr_subquery.a#13, $analytic.w#14]
    |             +-input_scan=
    |               +-AnalyticScan
    |                 +-column_list=[$aggregate.s2#6, $groupby.s#10, $groupby.x#11, $groupby.y#12, $expr_subquery.a#13, $analytic.w#14]
    |                 +-input_scan=
    |                 | +-ProjectScan
    |                 |   +-column_list=[$aggregate.s2#6, $groupby.s#10, $groupby.x#11, $groupby.y#12, $expr_subquery.a#13]
    |                 |   +-expr_list=
    |                 |   | +-a#13 :=
    |                 |   |   +-GetStructField
    |                 |   |     +-type=INT64
    |                 |   |     +-expr=
    |                 |   |     | +-ColumnRef(type=STRUCT<a INT64, b INT64>, column=outer_t.s2#2, is_correlated=TRUE)
    |                 |   |     +-field_idx=0
    |                 |   +-input_scan=
    |                 |     +-AggregateScan
    |                 |       +-column_list=[$groupby.s#10, $groupby.x#11, $groupby.y#12, $aggregate.s2#6]
    |                 |       +-input_scan=
    |                 |       | +-ProjectScan
    |                 |       |   +-column_list=[inner_t.x#3, inner_t.y#4, $preproject.$struct#5]
    |                 |       |   +-expr_list=
    |                 |       |   | +-$struct#5 := ColumnRef(type=STRUCT<x INT64, y INT64>, column=outer_t.s#1, is_correlated=TRUE)
    |                 |       |   +-input_scan=
    |                 |       |     +-FilterScan
    |                 |       |       +-column_list=inner_t.[x#3, y#4]
    |                 |       |       +-input_scan=
    |                 |       |       | +-ProjectScan
    |                 |       |       |   +-column_list=inner_t.[x#3, y#4]
    |                 |       |       |   +-expr_list=
    |                 |       |       |   | +-x#3 := Literal(type=INT64, value=1)
    |                 |       |       |   | +-y#4 := Literal(type=INT64, value=2)
    |                 |       |       |   +-input_scan=
    |                 |       |       |     +-SingleRowScan
    |                 |       |       +-filter_expr=
    |                 |       |         +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
    |                 |       |           +-GetStructField
    |                 |       |           | +-type=INT64
    |                 |       |           | +-expr=
    |                 |       |           | | +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=outer_t.s#1, is_correlated=TRUE)
    |                 |       |           | +-field_idx=0
    |                 |       |           +-Literal(type=INT64, value=0)
    |                 |       +-group_by_list=
    |                 |       | +-s#8 := ColumnRef(type=STRUCT<x INT64, y INT64>, column=outer_t.s#1, is_correlated=TRUE)
    |                 |       | +-s2#9 := ColumnRef(type=STRUCT<a INT64, b INT64>, column=outer_t.s2#2, is_correlated=TRUE)
    |                 |       | +-s#10 :=
    |                 |       | | +-MakeStruct
    |                 |       | |   +-type=STRUCT<a DOUBLE, b DOUBLE>
    |                 |       | |   +-field_list=
    |                 |       | |     +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
    |                 |       | |     | +-Cast(INT64 -> DOUBLE)
    |                 |       | |     | | +-GetStructField
    |                 |       | |     | |   +-type=INT64
    |                 |       | |     | |   +-expr=
    |                 |       | |     | |   | +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=outer_t.s#1, is_correlated=TRUE)
    |                 |       | |     | |   +-field_idx=0
    |                 |       | |     | +-FunctionCall(ZetaSQL:rand() -> DOUBLE)
    |                 |       | |     +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
    |                 |       | |       +-Cast(INT64 -> DOUBLE)
    |                 |       | |       | +-GetStructField
    |                 |       | |       |   +-type=INT64
    |                 |       | |       |   +-expr=
    |                 |       | |       |   | +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=outer_t.s#1, is_correlated=TRUE)
    |                 |       | |       |   +-field_idx=1
    |                 |       | |       +-FunctionCall(ZetaSQL:rand() -> DOUBLE)
    |                 |       | +-x#11 :=
    |                 |       | | +-GetStructField
    |                 |       | |   +-type=INT64
    |                 |       | |   +-expr=
    |                 |       | |   | +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=$preproject.$struct#5)
    |                 |       | |   +-field_idx=0
    |                 |       | +-y#12 :=
    |                 |       |   +-GetStructField
    |                 |       |     +-type=INT64
    |                 |       |     +-expr=
    |                 |       |     | +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=$preproject.$struct#5)
    |                 |       |     +-field_idx=1
    |                 |       +-aggregate_list=
    |                 |         +-s2#6 :=
    |                 |           +-AggregateFunctionCall(ZetaSQL:any_value(STRUCT<x INT64, y INT64>) -> STRUCT<x INT64, y INT64>)
    |                 |             +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=outer_t.s#1, is_correlated=TRUE)
    |                 +-function_group_list=
    |                   +-AnalyticFunctionGroup
    |                     +-analytic_function_list=
    |                       +-w#14 :=
    |                         +-AnalyticFunctionCall(ZetaSQL:sum(INT64) -> INT64)
    |                           +-GetStructField
    |                             +-type=INT64
    |                             +-expr=
    |                             | +-ColumnRef(type=STRUCT<a INT64, b INT64>, column=outer_t.s2#2, is_correlated=TRUE)
    |                             +-field_idx=0
    |                           +-window_frame=
    |                             +-WindowFrame(frame_unit=ROWS)
    |                               +-start_expr=
    |                               | +-WindowFrameExpr(boundary_type=UNBOUNDED PRECEDING)
    |                               +-end_expr=
    |                                 +-WindowFrameExpr(boundary_type=UNBOUNDED FOLLOWING)
    +-input_scan=
      +-ProjectScan
        +-column_list=outer_t.[s#1, s2#2]
        +-expr_list=
        | +-s#1 := Literal(type=STRUCT<x INT64, y INT64>, value={x:1, y:2})
        | +-s2#2 := Literal(type=STRUCT<a INT64, b INT64>, value={a:10, b:20})
        +-input_scan=
          +-SingleRowScan


DEPRECATION WARNING:
Lateral column alias will shadow original target: STRUCT<x INT64, y INT64> (outer_t.s#1) [at 7:15]
    ANY_VALUE(s) AS s2,
              ^
[zetasql.DeprecationWarning] { kind: LATERAL_COLUMN_REFERENCE }

DEPRECATION WARNING:
Lateral column alias will shadow original target: STRUCT<a INT64, b INT64> (outer_t.s2#2) [at 8:5]
    s2.a,
    ^
[zetasql.DeprecationWarning] { kind: LATERAL_COLUMN_REFERENCE }
==

# Same but without aggregation, to test dot-star all the way without marking it
# in the GROUP BY.
SELECT
  (SELECT AS STRUCT
    s.*,
    STRUCT(s.x + rand() AS a, s.y + rand() AS b) AS s,  # Changes names and types
    ANY_VALUE(s) OVER() AS s2,
    s2.*
   FROM (SELECT 1 AS x, 2 AS y) AS inner_t
   WHERE s.x < 0
  )
FROM
  (SELECT
    STRUCT(1 AS x, 2 AS y) AS s,
    STRUCT(10 AS a, 20 AS b) AS s2
  ) AS outer_t
--
QueryStmt
+-output_column_list=
| +-$query.$col1#15 AS `$col1` [STRUCT<x INT64, y INT64, s STRUCT<a DOUBLE, b DOUBLE>, s2 STRUCT<x INT64, y INT64>, a INT64, b INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#15]
    +-expr_list=
    | +-$col1#15 :=
    |   +-SubqueryExpr
    |     +-type=STRUCT<x INT64, y INT64, s STRUCT<a DOUBLE, b DOUBLE>, s2 STRUCT<x INT64, y INT64>, a INT64, b INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=outer_t.s#1)
    |     | +-ColumnRef(type=STRUCT<a INT64, b INT64>, column=outer_t.s2#2)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$make_struct.$struct#14]
    |         +-expr_list=
    |         | +-$struct#14 :=
    |         |   +-MakeStruct
    |         |     +-type=STRUCT<x INT64, y INT64, s STRUCT<a DOUBLE, b DOUBLE>, s2 STRUCT<x INT64, y INT64>, a INT64, b INT64>
    |         |     +-field_list=
    |         |       +-ColumnRef(type=INT64, column=$expr_subquery.x#8)
    |         |       +-ColumnRef(type=INT64, column=$expr_subquery.y#9)
    |         |       +-ColumnRef(type=STRUCT<a DOUBLE, b DOUBLE>, column=$expr_subquery.s#10)
    |         |       +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=$analytic.s2#11)
    |         |       +-ColumnRef(type=INT64, column=$expr_subquery.a#12)
    |         |       +-ColumnRef(type=INT64, column=$expr_subquery.b#13)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$expr_subquery.x#8, $expr_subquery.y#9, $expr_subquery.s#10, $analytic.s2#11, $expr_subquery.a#12, $expr_subquery.b#13]
    |             +-input_scan=
    |               +-AnalyticScan
    |                 +-column_list=[inner_t.x#3, inner_t.y#4, $preproject.$struct#5, $preproject.$struct#7, $expr_subquery.x#8, $expr_subquery.y#9, $expr_subquery.s#10, $expr_subquery.a#12, $expr_subquery.b#13, $analytic.s2#11]
    |                 +-input_scan=
    |                 | +-ProjectScan
    |                 |   +-column_list=[inner_t.x#3, inner_t.y#4, $preproject.$struct#5, $preproject.$struct#7, $expr_subquery.x#8, $expr_subquery.y#9, $expr_subquery.s#10, $expr_subquery.a#12, $expr_subquery.b#13]
    |                 |   +-expr_list=
    |                 |   | +-x#8 :=
    |                 |   | | +-GetStructField
    |                 |   | |   +-type=INT64
    |                 |   | |   +-expr=
    |                 |   | |   | +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=$preproject.$struct#5)
    |                 |   | |   +-field_idx=0
    |                 |   | +-y#9 :=
    |                 |   | | +-GetStructField
    |                 |   | |   +-type=INT64
    |                 |   | |   +-expr=
    |                 |   | |   | +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=$preproject.$struct#5)
    |                 |   | |   +-field_idx=1
    |                 |   | +-s#10 :=
    |                 |   | | +-MakeStruct
    |                 |   | |   +-type=STRUCT<a DOUBLE, b DOUBLE>
    |                 |   | |   +-field_list=
    |                 |   | |     +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
    |                 |   | |     | +-Cast(INT64 -> DOUBLE)
    |                 |   | |     | | +-GetStructField
    |                 |   | |     | |   +-type=INT64
    |                 |   | |     | |   +-expr=
    |                 |   | |     | |   | +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=outer_t.s#1, is_correlated=TRUE)
    |                 |   | |     | |   +-field_idx=0
    |                 |   | |     | +-FunctionCall(ZetaSQL:rand() -> DOUBLE)
    |                 |   | |     +-FunctionCall(ZetaSQL:$add(DOUBLE, DOUBLE) -> DOUBLE)
    |                 |   | |       +-Cast(INT64 -> DOUBLE)
    |                 |   | |       | +-GetStructField
    |                 |   | |       |   +-type=INT64
    |                 |   | |       |   +-expr=
    |                 |   | |       |   | +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=outer_t.s#1, is_correlated=TRUE)
    |                 |   | |       |   +-field_idx=1
    |                 |   | |       +-FunctionCall(ZetaSQL:rand() -> DOUBLE)
    |                 |   | +-a#12 :=
    |                 |   | | +-GetStructField
    |                 |   | |   +-type=INT64
    |                 |   | |   +-expr=
    |                 |   | |   | +-ColumnRef(type=STRUCT<a INT64, b INT64>, column=$preproject.$struct#7)
    |                 |   | |   +-field_idx=0
    |                 |   | +-b#13 :=
    |                 |   |   +-GetStructField
    |                 |   |     +-type=INT64
    |                 |   |     +-expr=
    |                 |   |     | +-ColumnRef(type=STRUCT<a INT64, b INT64>, column=$preproject.$struct#7)
    |                 |   |     +-field_idx=1
    |                 |   +-input_scan=
    |                 |     +-ProjectScan
    |                 |       +-column_list=[inner_t.x#3, inner_t.y#4, $preproject.$struct#5, $preproject.$struct#7]
    |                 |       +-expr_list=
    |                 |       | +-$struct#5 := ColumnRef(type=STRUCT<x INT64, y INT64>, column=outer_t.s#1, is_correlated=TRUE)
    |                 |       | +-$struct#7 := ColumnRef(type=STRUCT<a INT64, b INT64>, column=outer_t.s2#2, is_correlated=TRUE)
    |                 |       +-input_scan=
    |                 |         +-FilterScan
    |                 |           +-column_list=inner_t.[x#3, y#4]
    |                 |           +-input_scan=
    |                 |           | +-ProjectScan
    |                 |           |   +-column_list=inner_t.[x#3, y#4]
    |                 |           |   +-expr_list=
    |                 |           |   | +-x#3 := Literal(type=INT64, value=1)
    |                 |           |   | +-y#4 := Literal(type=INT64, value=2)
    |                 |           |   +-input_scan=
    |                 |           |     +-SingleRowScan
    |                 |           +-filter_expr=
    |                 |             +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
    |                 |               +-GetStructField
    |                 |               | +-type=INT64
    |                 |               | +-expr=
    |                 |               | | +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=outer_t.s#1, is_correlated=TRUE)
    |                 |               | +-field_idx=0
    |                 |               +-Literal(type=INT64, value=0)
    |                 +-function_group_list=
    |                   +-AnalyticFunctionGroup
    |                     +-analytic_function_list=
    |                       +-s2#11 :=
    |                         +-AnalyticFunctionCall(ZetaSQL:any_value(STRUCT<x INT64, y INT64>) -> STRUCT<x INT64, y INT64>)
    |                           +-ColumnRef(type=STRUCT<x INT64, y INT64>, column=outer_t.s#1, is_correlated=TRUE)
    |                           +-window_frame=
    |                             +-WindowFrame(frame_unit=ROWS)
    |                               +-start_expr=
    |                               | +-WindowFrameExpr(boundary_type=UNBOUNDED PRECEDING)
    |                               +-end_expr=
    |                                 +-WindowFrameExpr(boundary_type=UNBOUNDED FOLLOWING)
    +-input_scan=
      +-ProjectScan
        +-column_list=outer_t.[s#1, s2#2]
        +-expr_list=
        | +-s#1 := Literal(type=STRUCT<x INT64, y INT64>, value={x:1, y:2})
        | +-s2#2 := Literal(type=STRUCT<a INT64, b INT64>, value={a:10, b:20})
        +-input_scan=
          +-SingleRowScan


DEPRECATION WARNING:
Lateral column alias will shadow original target: STRUCT<x INT64, y INT64> (outer_t.s#1) [at 5:15]
    ANY_VALUE(s) OVER() AS s2,
              ^
[zetasql.DeprecationWarning] { kind: LATERAL_COLUMN_REFERENCE }

DEPRECATION WARNING:
Lateral column alias will shadow original target: STRUCT<a INT64, b INT64> (outer_t.s2#2) [at 6:5]
    s2.*
    ^
[zetasql.DeprecationWarning] { kind: LATERAL_COLUMN_REFERENCE }
==

# Also catches when the lateral aliases would be causing ambiguity errors.
SELECT
  (SELECT AS STRUCT
   rand() AS a,
   3.0 AS a,
   a + 1 AS b
   FROM (SELECT 1)
  )
FROM (SELECT 1 AS a) AS outer_t
--
QueryStmt
+-output_column_list=
| +-$query.$col1#7 AS `$col1` [STRUCT<a DOUBLE, a DOUBLE, b INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#7]
    +-expr_list=
    | +-$col1#7 :=
    |   +-SubqueryExpr
    |     +-type=STRUCT<a DOUBLE, a DOUBLE, b INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=outer_t.a#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$make_struct.$struct#6]
    |         +-expr_list=
    |         | +-$struct#6 :=
    |         |   +-MakeStruct
    |         |     +-type=STRUCT<a DOUBLE, a DOUBLE, b INT64>
    |         |     +-field_list=
    |         |       +-ColumnRef(type=DOUBLE, column=$expr_subquery.a#3)
    |         |       +-ColumnRef(type=DOUBLE, column=$expr_subquery.a#4)
    |         |       +-ColumnRef(type=INT64, column=$expr_subquery.b#5)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=$expr_subquery.[a#3, a#4, b#5]
    |             +-expr_list=
    |             | +-a#3 := FunctionCall(ZetaSQL:rand() -> DOUBLE)
    |             | +-a#4 := Literal(type=DOUBLE, value=3, float_literal_id=1)
    |             | +-b#5 :=
    |             |   +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
    |             |     +-ColumnRef(type=INT64, column=outer_t.a#1, is_correlated=TRUE)
    |             |     +-Literal(type=INT64, value=1)
    |             +-input_scan=
    |               +-ProjectScan
    |                 +-column_list=[$subquery1.$col1#2]
    |                 +-expr_list=
    |                 | +-$col1#2 := Literal(type=INT64, value=1)
    |                 +-input_scan=
    |                   +-SingleRowScan
    +-input_scan=
      +-ProjectScan
        +-column_list=[outer_t.a#1]
        +-expr_list=
        | +-a#1 := Literal(type=INT64, value=1)
        +-input_scan=
          +-SingleRowScan


DEPRECATION WARNING:
Lateral column alias will shadow original target: INT64 (outer_t.a#1) [at 5:4]
   a + 1 AS b
   ^
[zetasql.DeprecationWarning] { kind: LATERAL_COLUMN_REFERENCE }
