# Reject cross joins on two tables containing private data, there's no ON clause
[default language_features=ANONYMIZATION]
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a,
     SimpleTypesWithAnonymizationUid b;
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-JoinScan
        |   +-left_scan=
        |   | +-TableScan(table=SimpleTypesWithAnonymizationUid, alias="a")
        |   +-right_scan=
        |     +-TableScan(table=SimpleTypesWithAnonymizationUid, alias="b")
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

Rewrite ERROR: Joins between tables containing private data must explicitly join on the user id column in each table, add 'ON a.uid=b.uid'
==

# join where both tables contain user data with explicit left.uid = right.uid
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a
inner join SimpleTypesWithAnonymizationUid b on a.uid = b.uid;
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   +-left_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   +-right_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#27, $group_by.$uid#28]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   |   +-left_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   |   +-right_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   |   +-join_expr=
        |   |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        |   +-group_by_list=
        |   | +-$uid#28 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   +-aggregate_list=
        |     +-$agg1_partial#27 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
        | +-$agg1#25 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#27)
        | |   +-Literal(type=INT64, value=0)
        | |   +-Literal(type=INT64, value=100)
        | +-$k_threshold_col#31 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#31)

[TableScan Groups]
{
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
}
==

# incomplete join condition
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a
inner join SimpleTypesWithAnonymizationUid b on a.uid = a.uid;
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-166
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-JoinScan
        |   +-parse_location=105-115
        |   +-column_list=[SimpleTypesWithAnonymizationUid.uid#11]
        |   +-left_scan=
        |   | +-TableScan(parse_location=71-102, column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   +-right_scan=
        |   | +-TableScan(parse_location=116-147, table=SimpleTypesWithAnonymizationUid, alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(parse_location=153-158, type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |       +-ColumnRef(parse_location=161-166, type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-parse_location=26-36
              +-Literal(parse_location=55-56, type=INT64, value=0)
              +-Literal(parse_location=61-64, type=INT64, value=100)
[REPLACED_LITERALS]
select with anonymization anon_count(* CLAMPED BETWEEN @_p0_INT64 AND @_p1_INT64)
from SimpleTypesWithAnonymizationUid a
inner join SimpleTypesWithAnonymizationUid b on a.uid = a.uid;

Rewrite ERROR: Joins between tables containing private data must also explicitly join on the user id column in each table, add 'AND a.uid=b.uid' to the join ON expression [at 1:1]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
^
==

# reject disjoint join condition
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a
inner join SimpleTypesWithAnonymizationUid b on (a.uid = a.uid or a.int64 = b.int64);
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-189
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-JoinScan
        |   +-parse_location=105-115
        |   +-column_list=SimpleTypesWithAnonymizationUid.[int64#2, uid#11, int64#14]
        |   +-left_scan=
        |   | +-TableScan(parse_location=71-102, column_list=SimpleTypesWithAnonymizationUid.[int64#2, uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[1, 10], alias="a")
        |   +-right_scan=
        |   | +-TableScan(parse_location=116-147, column_list=[SimpleTypesWithAnonymizationUid.int64#14], table=SimpleTypesWithAnonymizationUid, column_index_list=[1], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$or(BOOL, repeated(1) BOOL) -> BOOL)
        |       +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       | +-ColumnRef(parse_location=154-159, type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |       | +-ColumnRef(parse_location=162-167, type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |       +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |         +-ColumnRef(parse_location=171-178, type=INT64, column=SimpleTypesWithAnonymizationUid.int64#2)
        |         +-ColumnRef(parse_location=181-188, type=INT64, column=SimpleTypesWithAnonymizationUid.int64#14)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-parse_location=26-36
              +-Literal(parse_location=55-56, type=INT64, value=0)
              +-Literal(parse_location=61-64, type=INT64, value=100)
[REPLACED_LITERALS]
select with anonymization anon_count(* CLAMPED BETWEEN @_p0_INT64 AND @_p1_INT64)
from SimpleTypesWithAnonymizationUid a
inner join SimpleTypesWithAnonymizationUid b on (a.uid = a.uid or a.int64 = b.int64);

Rewrite ERROR: Joins between tables containing private data must also explicitly join on the user id column in each table, add 'AND a.uid=b.uid' to the join ON expression [at 1:1]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
^
==

# incomplete join condition
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a
inner join SimpleTypesWithAnonymizationUid b on b.uid = b.uid;
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-166
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-JoinScan
        |   +-parse_location=105-115
        |   +-column_list=[SimpleTypesWithAnonymizationUid.uid#23]
        |   +-left_scan=
        |   | +-TableScan(parse_location=71-102, table=SimpleTypesWithAnonymizationUid, alias="a")
        |   +-right_scan=
        |   | +-TableScan(parse_location=116-147, column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(parse_location=153-158, type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        |       +-ColumnRef(parse_location=161-166, type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-parse_location=26-36
              +-Literal(parse_location=55-56, type=INT64, value=0)
              +-Literal(parse_location=61-64, type=INT64, value=100)
[REPLACED_LITERALS]
select with anonymization anon_count(* CLAMPED BETWEEN @_p0_INT64 AND @_p1_INT64)
from SimpleTypesWithAnonymizationUid a
inner join SimpleTypesWithAnonymizationUid b on b.uid = b.uid;

Rewrite ERROR: Joins between tables containing private data must also explicitly join on the user id column in each table, add 'AND a.uid=b.uid' to the join ON expression [at 1:1]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
^
==

# Reject join conditions that aren't trivial comparisions
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a
inner join SimpleTypesWithAnonymizationUid b on
  CAST(a.uid as string) = CAST(b.uid as string);
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   +-left_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   +-right_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(STRING, STRING) -> BOOL)
        |       +-Cast(INT64 -> STRING)
        |       | +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |       +-Cast(INT64 -> STRING)
        |         +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

Rewrite ERROR: Joins between tables containing private data must also explicitly join on the user id column in each table, add 'AND a.uid=b.uid' to the join ON expression
==

# don't show internal aliases for join condition errors
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from
SimpleTypesWithAnonymizationUid a
full outer join SimpleTypesWithAnonymizationUid b on a.uid = b.uid
cross join SimpleTypesWithAnonymizationUid;
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#37 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#37]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#37]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   +-left_scan=
        |   | +-JoinScan
        |   |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   |   +-join_type=FULL
        |   |   +-left_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   |   +-right_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   |   +-join_expr=
        |   |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        |   +-right_scan=
        |     +-TableScan(table=SimpleTypesWithAnonymizationUid)
        +-aggregate_list=
          +-$agg1#37 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

Rewrite ERROR: Joins between tables containing private data must explicitly join on the user id column in each table
==

# join where both tables contain user data with explicit using(uid)
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a
inner join SimpleTypesWithAnonymizationUid b using(uid);
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   +-left_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   +-right_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#27, $group_by.$uid#28]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   |   +-left_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   |   +-right_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   |   +-join_expr=
        |   |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        |   +-group_by_list=
        |   | +-$uid#28 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   +-aggregate_list=
        |     +-$agg1_partial#27 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
        | +-$agg1#25 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#27)
        | |   +-Literal(type=INT64, value=0)
        | |   +-Literal(type=INT64, value=100)
        | +-$k_threshold_col#31 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#31)

[TableScan Groups]
{
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
}
==

# join where both tables contain user data with where a.uid=b.uid
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a, SimpleTypesWithAnonymizationUid b
where a.uid=b.uid;
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-FilterScan
        |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   |   +-left_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   |   +-right_scan=
        |   |     +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   +-filter_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

Rewrite ERROR: Joins between tables containing private data must explicitly join on the user id column in each table, add 'ON a.uid=b.uid'
==

# join with 'where' clause for join condition, and implicit aliasing
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid, SimpleTypesWithAnonymizationUid b
where SimpleTypesWithAnonymizationUid.uid=b.uid;
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-FilterScan
        |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   |   +-left_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10])
        |   |   +-right_scan=
        |   |     +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   +-filter_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

Rewrite ERROR: Joins between tables containing private data must explicitly join on the user id column in each table, add 'ON uid=b.uid'
==

# use full table names as uid qualifiers where it reduces ambiguity
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from T1StringAnonymizationUid, T2StringAnonymizationUid;
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#5 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#5]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#5]
        +-input_scan=
        | +-JoinScan
        |   +-left_scan=
        |   | +-TableScan(table=T1StringAnonymizationUid)
        |   +-right_scan=
        |     +-TableScan(table=T2StringAnonymizationUid)
        +-aggregate_list=
          +-$agg1#5 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

Rewrite ERROR: Joins between tables containing private data must explicitly join on the user id column in each table, add 'ON T1StringAnonymizationUid.uid=T2StringAnonymizationUid.uid'
==

# Nested cross/inner joins, with some tables containing user data and some not
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from
  ((SimpleTypes a cross join SimpleTypes b)
  cross join SimpleTypesWithAnonymizationUid c)
  inner join SimpleTypesWithAnonymizationUid d on c.uid=d.uid;
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#61 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#61]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#61]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#47, uid#59]
        |   +-left_scan=
        |   | +-JoinScan
        |   |   +-column_list=[SimpleTypesWithAnonymizationUid.uid#47]
        |   |   +-left_scan=
        |   |   | +-JoinScan
        |   |   |   +-left_scan=
        |   |   |   | +-TableScan(table=SimpleTypes, alias="a")
        |   |   |   +-right_scan=
        |   |   |     +-TableScan(table=SimpleTypes, alias="b")
        |   |   +-right_scan=
        |   |     +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#47], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="c")
        |   +-right_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#59], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="d")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#47)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#59)
        +-aggregate_list=
          +-$agg1#61 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#61 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#61]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#61]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#63, $group_by.$uid#64]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#47, uid#59]
        |   |   +-left_scan=
        |   |   | +-JoinScan
        |   |   |   +-column_list=[SimpleTypesWithAnonymizationUid.uid#47]
        |   |   |   +-left_scan=
        |   |   |   | +-JoinScan
        |   |   |   |   +-left_scan=
        |   |   |   |   | +-TableScan(table=SimpleTypes, alias="a")
        |   |   |   |   +-right_scan=
        |   |   |   |     +-TableScan(table=SimpleTypes, alias="b")
        |   |   |   +-right_scan=
        |   |   |     +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#47], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="c")
        |   |   +-right_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#59], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="d")
        |   |   +-join_expr=
        |   |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#47)
        |   |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#59)
        |   +-group_by_list=
        |   | +-$uid#64 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#47)
        |   +-aggregate_list=
        |     +-$agg1_partial#63 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
        | +-$agg1#61 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#63)
        | |   +-Literal(type=INT64, value=0)
        | |   +-Literal(type=INT64, value=100)
        | +-$k_threshold_col#67 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#67)

[TableScan Groups]
{
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#47], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="c")
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#59], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="d")
}
==

# reject joins where both tables contain user data without explict uid join
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a
inner join SimpleTypesWithAnonymizationUid b on a.int64 = b.int64;
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=SimpleTypesWithAnonymizationUid.[int64#2, int64#14]
        |   +-left_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.int64#2], table=SimpleTypesWithAnonymizationUid, column_index_list=[1], alias="a")
        |   +-right_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.int64#14], table=SimpleTypesWithAnonymizationUid, column_index_list=[1], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.int64#2)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.int64#14)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

Rewrite ERROR: Joins between tables containing private data must also explicitly join on the user id column in each table, add 'AND a.uid=b.uid' to the join ON expression
==

# allow joins where both tables contain user data with complex join expr
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a
inner join SimpleTypesWithAnonymizationUid b on (a.int64 = b.int64 and
a.int32 = b.int32 and (a.string = b.string and a.uid = b.uid));
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=SimpleTypesWithAnonymizationUid.[int32#1, int64#2, string#5, uid#11, int32#13, int64#14, string#17, uid#23]
        |   +-left_scan=
        |   | +-TableScan(column_list=SimpleTypesWithAnonymizationUid.[int32#1, int64#2, string#5, uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[0, 1, 4, 10], alias="a")
        |   +-right_scan=
        |   | +-TableScan(column_list=SimpleTypesWithAnonymizationUid.[int32#13, int64#14, string#17, uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[0, 1, 4, 10], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$and(BOOL, repeated(2) BOOL) -> BOOL)
        |       +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       | +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.int64#2)
        |       | +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.int64#14)
        |       +-FunctionCall(ZetaSQL:$equal(INT32, INT32) -> BOOL)
        |       | +-ColumnRef(type=INT32, column=SimpleTypesWithAnonymizationUid.int32#1)
        |       | +-ColumnRef(type=INT32, column=SimpleTypesWithAnonymizationUid.int32#13)
        |       +-FunctionCall(ZetaSQL:$and(BOOL, repeated(1) BOOL) -> BOOL)
        |         +-FunctionCall(ZetaSQL:$equal(STRING, STRING) -> BOOL)
        |         | +-ColumnRef(type=STRING, column=SimpleTypesWithAnonymizationUid.string#5)
        |         | +-ColumnRef(type=STRING, column=SimpleTypesWithAnonymizationUid.string#17)
        |         +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |           +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |           +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#27, $group_by.$uid#28]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-column_list=SimpleTypesWithAnonymizationUid.[int32#1, int64#2, string#5, uid#11, int32#13, int64#14, string#17, uid#23]
        |   |   +-left_scan=
        |   |   | +-TableScan(column_list=SimpleTypesWithAnonymizationUid.[int32#1, int64#2, string#5, uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[0, 1, 4, 10], alias="a")
        |   |   +-right_scan=
        |   |   | +-TableScan(column_list=SimpleTypesWithAnonymizationUid.[int32#13, int64#14, string#17, uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[0, 1, 4, 10], alias="b")
        |   |   +-join_expr=
        |   |     +-FunctionCall(ZetaSQL:$and(BOOL, repeated(2) BOOL) -> BOOL)
        |   |       +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |       | +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.int64#2)
        |   |       | +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.int64#14)
        |   |       +-FunctionCall(ZetaSQL:$equal(INT32, INT32) -> BOOL)
        |   |       | +-ColumnRef(type=INT32, column=SimpleTypesWithAnonymizationUid.int32#1)
        |   |       | +-ColumnRef(type=INT32, column=SimpleTypesWithAnonymizationUid.int32#13)
        |   |       +-FunctionCall(ZetaSQL:$and(BOOL, repeated(1) BOOL) -> BOOL)
        |   |         +-FunctionCall(ZetaSQL:$equal(STRING, STRING) -> BOOL)
        |   |         | +-ColumnRef(type=STRING, column=SimpleTypesWithAnonymizationUid.string#5)
        |   |         | +-ColumnRef(type=STRING, column=SimpleTypesWithAnonymizationUid.string#17)
        |   |         +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |           +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   |           +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        |   +-group_by_list=
        |   | +-$uid#28 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   +-aggregate_list=
        |     +-$agg1_partial#27 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
        | +-$agg1#25 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#27)
        | |   +-Literal(type=INT64, value=0)
        | |   +-Literal(type=INT64, value=100)
        | +-$k_threshold_col#31 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#31)

[TableScan Groups]
{
  TableScan(column_list=SimpleTypesWithAnonymizationUid.[int32#1, int64#2, string#5, uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[0, 1, 4, 10], alias="a")
  TableScan(column_list=SimpleTypesWithAnonymizationUid.[int32#13, int64#14, string#17, uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[0, 1, 4, 10], alias="b")
}
==

# complex join expr
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a
inner join SimpleTypesWithAnonymizationUid b on (a.uid = b.uid and a.uid = b.uid);
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   +-left_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   +-right_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$and(BOOL, repeated(1) BOOL) -> BOOL)
        |       +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       | +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |       | +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        |       +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |         +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |         +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#27, $group_by.$uid#28]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   |   +-left_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   |   +-right_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   |   +-join_expr=
        |   |     +-FunctionCall(ZetaSQL:$and(BOOL, repeated(1) BOOL) -> BOOL)
        |   |       +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |       | +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   |       | +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        |   |       +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |         +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   |         +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        |   +-group_by_list=
        |   | +-$uid#28 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   +-aggregate_list=
        |     +-$agg1_partial#27 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
        | +-$agg1#25 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#27)
        | |   +-Literal(type=INT64, value=0)
        | |   +-Literal(type=INT64, value=100)
        | +-$k_threshold_col#31 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#31)

[TableScan Groups]
{
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
}
==

# complex join expr
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a
inner join SimpleTypesWithAnonymizationUid b on (a.int64 = b.int64 and a.int32 = b.int32);
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=SimpleTypesWithAnonymizationUid.[int32#1, int64#2, int32#13, int64#14]
        |   +-left_scan=
        |   | +-TableScan(column_list=SimpleTypesWithAnonymizationUid.[int32#1, int64#2], table=SimpleTypesWithAnonymizationUid, column_index_list=[0, 1], alias="a")
        |   +-right_scan=
        |   | +-TableScan(column_list=SimpleTypesWithAnonymizationUid.[int32#13, int64#14], table=SimpleTypesWithAnonymizationUid, column_index_list=[0, 1], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$and(BOOL, repeated(1) BOOL) -> BOOL)
        |       +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       | +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.int64#2)
        |       | +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.int64#14)
        |       +-FunctionCall(ZetaSQL:$equal(INT32, INT32) -> BOOL)
        |         +-ColumnRef(type=INT32, column=SimpleTypesWithAnonymizationUid.int32#1)
        |         +-ColumnRef(type=INT32, column=SimpleTypesWithAnonymizationUid.int32#13)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

Rewrite ERROR: Joins between tables containing private data must also explicitly join on the user id column in each table, add 'AND a.uid=b.uid' to the join ON expression
==

# reject right join with non-uid right table
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a
right join SimpleTypes b on a.int64 = b.int64
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#31 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-150
    +-column_list=[$aggregate.$agg1#31]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#31]
        +-input_scan=
        | +-JoinScan
        |   +-parse_location=105-115
        |   +-column_list=[SimpleTypesWithAnonymizationUid.int64#2, SimpleTypes.int64#14]
        |   +-join_type=RIGHT
        |   +-left_scan=
        |   | +-TableScan(parse_location=71-102, column_list=[SimpleTypesWithAnonymizationUid.int64#2], table=SimpleTypesWithAnonymizationUid, column_index_list=[1], alias="a")
        |   +-right_scan=
        |   | +-TableScan(parse_location=116-127, column_list=[SimpleTypes.int64#14], table=SimpleTypes, column_index_list=[1], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(parse_location=133-140, type=INT64, column=SimpleTypesWithAnonymizationUid.int64#2)
        |       +-ColumnRef(parse_location=143-150, type=INT64, column=SimpleTypes.int64#14)
        +-aggregate_list=
          +-$agg1#31 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-parse_location=26-36
              +-Literal(parse_location=55-56, type=INT64, value=0)
              +-Literal(parse_location=61-64, type=INT64, value=100)
[REPLACED_LITERALS]
select with anonymization anon_count(* CLAMPED BETWEEN @_p0_INT64 AND @_p1_INT64)
from SimpleTypesWithAnonymizationUid a
right join SimpleTypes b on a.int64 = b.int64

Rewrite ERROR: The right table in a RIGHT OUTER join must contain user data [at 3:12]
right join SimpleTypes b on a.int64 = b.int64
           ^
==

# accept right join with uid right table
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from (
  select b.uid from (
    SimpleTypes a
    right join SimpleTypesWithAnonymizationUid b on a.int64 = b.int64)
)
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#31 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#31]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#31]
        +-input_scan=
        | +-ProjectScan
        |   +-column_list=[SimpleTypesWithAnonymizationUid.uid#29]
        |   +-input_scan=
        |     +-JoinScan
        |       +-column_list=[SimpleTypes.int64#2, SimpleTypesWithAnonymizationUid.int64#20, SimpleTypesWithAnonymizationUid.uid#29]
        |       +-join_type=RIGHT
        |       +-left_scan=
        |       | +-TableScan(column_list=[SimpleTypes.int64#2], table=SimpleTypes, column_index_list=[1], alias="a")
        |       +-right_scan=
        |       | +-TableScan(column_list=SimpleTypesWithAnonymizationUid.[int64#20, uid#29], table=SimpleTypesWithAnonymizationUid, column_index_list=[1, 10], alias="b")
        |       +-join_expr=
        |         +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |           +-ColumnRef(type=INT64, column=SimpleTypes.int64#2)
        |           +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.int64#20)
        +-aggregate_list=
          +-$agg1#31 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#31 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#31]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#31]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#33, $group_by.$uid#34]
        |   +-input_scan=
        |   | +-ProjectScan
        |   |   +-column_list=[SimpleTypesWithAnonymizationUid.uid#29]
        |   |   +-input_scan=
        |   |     +-JoinScan
        |   |       +-column_list=[SimpleTypes.int64#2, SimpleTypesWithAnonymizationUid.int64#20, SimpleTypesWithAnonymizationUid.uid#29]
        |   |       +-join_type=RIGHT
        |   |       +-left_scan=
        |   |       | +-TableScan(column_list=[SimpleTypes.int64#2], table=SimpleTypes, column_index_list=[1], alias="a")
        |   |       +-right_scan=
        |   |       | +-TableScan(column_list=SimpleTypesWithAnonymizationUid.[int64#20, uid#29], table=SimpleTypesWithAnonymizationUid, column_index_list=[1, 10], alias="b")
        |   |       +-join_expr=
        |   |         +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |           +-ColumnRef(type=INT64, column=SimpleTypes.int64#2)
        |   |           +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.int64#20)
        |   +-group_by_list=
        |   | +-$uid#34 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#29)
        |   +-aggregate_list=
        |     +-$agg1_partial#33 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
        | +-$agg1#31 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#33)
        | |   +-Literal(type=INT64, value=0)
        | |   +-Literal(type=INT64, value=100)
        | +-$k_threshold_col#37 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#37)

[TableScan Groups]
{
  TableScan(column_list=SimpleTypesWithAnonymizationUid.[int64#20, uid#29], table=SimpleTypesWithAnonymizationUid, column_index_list=[1, 10], alias="b")
}
==

# reject right join projecting the wrong uid
# TODO: Fix the error message column alias
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from (
  select a.uid from (
    SimpleTypesWithAnonymizationUid a
    right join SimpleTypesWithAnonymizationUid b on a.uid = b.uid)
)
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-201
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-ProjectScan
        |   +-parse_location=75-199
        |   +-column_list=[SimpleTypesWithAnonymizationUid.uid#11]
        |   +-input_scan=
        |     +-JoinScan
        |       +-parse_location=137-147
        |       +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |       +-join_type=RIGHT
        |       +-left_scan=
        |       | +-TableScan(parse_location=99-130, column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |       +-right_scan=
        |       | +-TableScan(parse_location=148-179, column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |       +-join_expr=
        |         +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |           +-ColumnRef(parse_location=185-190, type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |           +-ColumnRef(parse_location=193-198, type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-parse_location=26-36
              +-Literal(parse_location=55-56, type=INT64, value=0)
              +-Literal(parse_location=61-64, type=INT64, value=100)
[REPLACED_LITERALS]
select with anonymization anon_count(* CLAMPED BETWEEN @_p0_INT64 AND @_p1_INT64)
from (
  select a.uid from (
    SimpleTypesWithAnonymizationUid a
    right join SimpleTypesWithAnonymizationUid b on a.uid = b.uid)
)

Rewrite ERROR: Subqueries of anonymization queries must explicitly SELECT the userid column 'b.uid' [at 3:3]
  select a.uid from (
  ^
==

# accept left join with uid left table
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from (
  select a.uid from (
    SimpleTypesWithAnonymizationUid a
    left join SimpleTypes b on a.int64 = b.int64)
)
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#31 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#31]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#31]
        +-input_scan=
        | +-ProjectScan
        |   +-column_list=[SimpleTypesWithAnonymizationUid.uid#11]
        |   +-input_scan=
        |     +-JoinScan
        |       +-column_list=[SimpleTypesWithAnonymizationUid.int64#2, SimpleTypesWithAnonymizationUid.uid#11, SimpleTypes.int64#14]
        |       +-join_type=LEFT
        |       +-left_scan=
        |       | +-TableScan(column_list=SimpleTypesWithAnonymizationUid.[int64#2, uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[1, 10], alias="a")
        |       +-right_scan=
        |       | +-TableScan(column_list=[SimpleTypes.int64#14], table=SimpleTypes, column_index_list=[1], alias="b")
        |       +-join_expr=
        |         +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |           +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.int64#2)
        |           +-ColumnRef(type=INT64, column=SimpleTypes.int64#14)
        +-aggregate_list=
          +-$agg1#31 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#31 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#31]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#31]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#33, $group_by.$uid#34]
        |   +-input_scan=
        |   | +-ProjectScan
        |   |   +-column_list=[SimpleTypesWithAnonymizationUid.uid#11]
        |   |   +-input_scan=
        |   |     +-JoinScan
        |   |       +-column_list=[SimpleTypesWithAnonymizationUid.int64#2, SimpleTypesWithAnonymizationUid.uid#11, SimpleTypes.int64#14]
        |   |       +-join_type=LEFT
        |   |       +-left_scan=
        |   |       | +-TableScan(column_list=SimpleTypesWithAnonymizationUid.[int64#2, uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[1, 10], alias="a")
        |   |       +-right_scan=
        |   |       | +-TableScan(column_list=[SimpleTypes.int64#14], table=SimpleTypes, column_index_list=[1], alias="b")
        |   |       +-join_expr=
        |   |         +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |           +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.int64#2)
        |   |           +-ColumnRef(type=INT64, column=SimpleTypes.int64#14)
        |   +-group_by_list=
        |   | +-$uid#34 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   +-aggregate_list=
        |     +-$agg1_partial#33 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
        | +-$agg1#31 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#33)
        | |   +-Literal(type=INT64, value=0)
        | |   +-Literal(type=INT64, value=100)
        | +-$k_threshold_col#37 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#37)

[TableScan Groups]
{
  TableScan(column_list=SimpleTypesWithAnonymizationUid.[int64#2, uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[1, 10], alias="a")
}
==

# reject left join with non-uid left table
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypes a
left join SimpleTypesWithAnonymizationUid b on a.int64 = b.int64
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#31 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-149
    +-column_list=[$aggregate.$agg1#31]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#31]
        +-input_scan=
        | +-JoinScan
        |   +-parse_location=85-94
        |   +-column_list=[SimpleTypes.int64#2, SimpleTypesWithAnonymizationUid.int64#20]
        |   +-join_type=LEFT
        |   +-left_scan=
        |   | +-TableScan(parse_location=71-82, column_list=[SimpleTypes.int64#2], table=SimpleTypes, column_index_list=[1], alias="a")
        |   +-right_scan=
        |   | +-TableScan(parse_location=95-126, column_list=[SimpleTypesWithAnonymizationUid.int64#20], table=SimpleTypesWithAnonymizationUid, column_index_list=[1], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(parse_location=132-139, type=INT64, column=SimpleTypes.int64#2)
        |       +-ColumnRef(parse_location=142-149, type=INT64, column=SimpleTypesWithAnonymizationUid.int64#20)
        +-aggregate_list=
          +-$agg1#31 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-parse_location=26-36
              +-Literal(parse_location=55-56, type=INT64, value=0)
              +-Literal(parse_location=61-64, type=INT64, value=100)
[REPLACED_LITERALS]
select with anonymization anon_count(* CLAMPED BETWEEN @_p0_INT64 AND @_p1_INT64)
from SimpleTypes a
left join SimpleTypesWithAnonymizationUid b on a.int64 = b.int64

Rewrite ERROR: The left table in a LEFT OUTER join must contain user data [at 2:6]
from SimpleTypes a
     ^
==

# reject left join projecting the wrong uid
# TODO: Fix the error message column alias
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from (
  select b.uid from (
    SimpleTypesWithAnonymizationUid a
    left join SimpleTypesWithAnonymizationUid b on a.uid = b.uid)
)
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-200
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-ProjectScan
        |   +-parse_location=75-198
        |   +-column_list=[SimpleTypesWithAnonymizationUid.uid#23]
        |   +-input_scan=
        |     +-JoinScan
        |       +-parse_location=137-146
        |       +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |       +-join_type=LEFT
        |       +-left_scan=
        |       | +-TableScan(parse_location=99-130, column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |       +-right_scan=
        |       | +-TableScan(parse_location=147-178, column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |       +-join_expr=
        |         +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |           +-ColumnRef(parse_location=184-189, type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |           +-ColumnRef(parse_location=192-197, type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-parse_location=26-36
              +-Literal(parse_location=55-56, type=INT64, value=0)
              +-Literal(parse_location=61-64, type=INT64, value=100)
[REPLACED_LITERALS]
select with anonymization anon_count(* CLAMPED BETWEEN @_p0_INT64 AND @_p1_INT64)
from (
  select b.uid from (
    SimpleTypesWithAnonymizationUid a
    left join SimpleTypesWithAnonymizationUid b on a.uid = b.uid)
)

Rewrite ERROR: Subqueries of anonymization queries must explicitly SELECT the userid column 'a.uid' [at 3:3]
  select b.uid from (
  ^
==

# reject full join with non-uid left table
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypes a
full outer join SimpleTypesWithAnonymizationUid b on a.int64 = b.int64
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#31 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-155
    +-column_list=[$aggregate.$agg1#31]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#31]
        +-input_scan=
        | +-JoinScan
        |   +-parse_location=85-100
        |   +-column_list=[SimpleTypes.int64#2, SimpleTypesWithAnonymizationUid.int64#20]
        |   +-join_type=FULL
        |   +-left_scan=
        |   | +-TableScan(parse_location=71-82, column_list=[SimpleTypes.int64#2], table=SimpleTypes, column_index_list=[1], alias="a")
        |   +-right_scan=
        |   | +-TableScan(parse_location=101-132, column_list=[SimpleTypesWithAnonymizationUid.int64#20], table=SimpleTypesWithAnonymizationUid, column_index_list=[1], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(parse_location=138-145, type=INT64, column=SimpleTypes.int64#2)
        |       +-ColumnRef(parse_location=148-155, type=INT64, column=SimpleTypesWithAnonymizationUid.int64#20)
        +-aggregate_list=
          +-$agg1#31 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-parse_location=26-36
              +-Literal(parse_location=55-56, type=INT64, value=0)
              +-Literal(parse_location=61-64, type=INT64, value=100)
[REPLACED_LITERALS]
select with anonymization anon_count(* CLAMPED BETWEEN @_p0_INT64 AND @_p1_INT64)
from SimpleTypes a
full outer join SimpleTypesWithAnonymizationUid b on a.int64 = b.int64

Rewrite ERROR: Both tables in a FULL OUTER join must contain user data [at 2:6]
from SimpleTypes a
     ^
==

# reject full join with non-uid right table
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a
full outer join SimpleTypes b on a.int64 = b.int64
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#31 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-155
    +-column_list=[$aggregate.$agg1#31]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#31]
        +-input_scan=
        | +-JoinScan
        |   +-parse_location=105-120
        |   +-column_list=[SimpleTypesWithAnonymizationUid.int64#2, SimpleTypes.int64#14]
        |   +-join_type=FULL
        |   +-left_scan=
        |   | +-TableScan(parse_location=71-102, column_list=[SimpleTypesWithAnonymizationUid.int64#2], table=SimpleTypesWithAnonymizationUid, column_index_list=[1], alias="a")
        |   +-right_scan=
        |   | +-TableScan(parse_location=121-132, column_list=[SimpleTypes.int64#14], table=SimpleTypes, column_index_list=[1], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(parse_location=138-145, type=INT64, column=SimpleTypesWithAnonymizationUid.int64#2)
        |       +-ColumnRef(parse_location=148-155, type=INT64, column=SimpleTypes.int64#14)
        +-aggregate_list=
          +-$agg1#31 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-parse_location=26-36
              +-Literal(parse_location=55-56, type=INT64, value=0)
              +-Literal(parse_location=61-64, type=INT64, value=100)
[REPLACED_LITERALS]
select with anonymization anon_count(* CLAMPED BETWEEN @_p0_INT64 AND @_p1_INT64)
from SimpleTypesWithAnonymizationUid a
full outer join SimpleTypes b on a.int64 = b.int64

Rewrite ERROR: Both tables in a FULL OUTER join must contain user data [at 3:17]
full outer join SimpleTypes b on a.int64 = b.int64
                ^
==

# accept full join with uid left and right table
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a
full outer join SimpleTypesWithAnonymizationUid b on a.uid = b.uid
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   +-join_type=FULL
        |   +-left_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   +-right_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#28, $group_by.$uid#29]
        |   +-input_scan=
        |   | +-ProjectScan
        |   |   +-column_list=[SimpleTypesWithAnonymizationUid.uid#11, SimpleTypesWithAnonymizationUid.uid#23, $join.$uid#26]
        |   |   +-expr_list=
        |   |   | +-$uid#26 :=
        |   |   |   +-FunctionCall(ZetaSQL:coalesce(repeated(2) INT64) -> INT64)
        |   |   |     +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   |   |     +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        |   |   +-input_scan=
        |   |     +-JoinScan
        |   |       +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23, uid#11, uid#23]
        |   |       +-join_type=FULL
        |   |       +-left_scan=
        |   |       | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   |       +-right_scan=
        |   |       | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   |       +-join_expr=
        |   |         +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |           +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   |           +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        |   +-group_by_list=
        |   | +-$uid#29 := ColumnRef(type=INT64, column=$join.$uid#26)
        |   +-aggregate_list=
        |     +-$agg1_partial#28 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
        | +-$agg1#25 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#28)
        | |   +-Literal(type=INT64, value=0)
        | |   +-Literal(type=INT64, value=100)
        | +-$k_threshold_col#32 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#32)

[TableScan Groups]
{
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
}
==

# reject full join with outer scan referencing uid
# TODO: Fix this error message to be more actionable to the end user
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from (
  select a.uid, b.uid
  from (
    SimpleTypesWithAnonymizationUid a
    full outer join SimpleTypesWithAnonymizationUid b on a.uid = b.uid)
);
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-215
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-ProjectScan
        |   +-parse_location=75-213
        |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   +-input_scan=
        |     +-JoinScan
        |       +-parse_location=146-161
        |       +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |       +-join_type=FULL
        |       +-left_scan=
        |       | +-TableScan(parse_location=108-139, column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |       +-right_scan=
        |       | +-TableScan(parse_location=162-193, column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |       +-join_expr=
        |         +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |           +-ColumnRef(parse_location=199-204, type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |           +-ColumnRef(parse_location=207-212, type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-parse_location=26-36
              +-Literal(parse_location=55-56, type=INT64, value=0)
              +-Literal(parse_location=61-64, type=INT64, value=100)
[REPLACED_LITERALS]
select with anonymization anon_count(* CLAMPED BETWEEN @_p0_INT64 AND @_p1_INT64)
from (
  select a.uid, b.uid
  from (
    SimpleTypesWithAnonymizationUid a
    full outer join SimpleTypesWithAnonymizationUid b on a.uid = b.uid)
);

Rewrite ERROR: Subqueries of anonymization queries must explicitly SELECT the userid column '' [at 3:3]
  select a.uid, b.uid
  ^
==

# joins require matching uid types
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a, T1StringAnonymizationUid b
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#15 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-132
    +-column_list=[$aggregate.$agg1#15]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#15]
        +-input_scan=
        | +-JoinScan
        |   +-parse_location=104-105
        |   +-left_scan=
        |   | +-TableScan(parse_location=71-102, table=SimpleTypesWithAnonymizationUid, alias="a")
        |   +-right_scan=
        |     +-TableScan(parse_location=106-130, table=T1StringAnonymizationUid, alias="b")
        +-aggregate_list=
          +-$agg1#15 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-parse_location=26-36
              +-Literal(parse_location=55-56, type=INT64, value=0)
              +-Literal(parse_location=61-64, type=INT64, value=100)
[REPLACED_LITERALS]
select with anonymization anon_count(* CLAMPED BETWEEN @_p0_INT64 AND @_p1_INT64)
from SimpleTypesWithAnonymizationUid a, T1StringAnonymizationUid b

Rewrite ERROR: Joining two tables containing private data requires matching user id column types, instead got INT64 and STRING [at 2:39]
from SimpleTypesWithAnonymizationUid a, T1StringAnonymizationUid b
                                      ^
==

# joins require equality comparable uid types
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from ProtoAnonymizationUid a, ProtoAnonymizationUid b
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#3 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-119
    +-column_list=[$aggregate.$agg1#3]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#3]
        +-input_scan=
        | +-JoinScan
        |   +-parse_location=94-95
        |   +-left_scan=
        |   | +-TableScan(parse_location=71-92, table=ProtoAnonymizationUid, alias="a")
        |   +-right_scan=
        |     +-TableScan(parse_location=96-117, table=ProtoAnonymizationUid, alias="b")
        +-aggregate_list=
          +-$agg1#3 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-parse_location=26-36
              +-Literal(parse_location=55-56, type=INT64, value=0)
              +-Literal(parse_location=61-64, type=INT64, value=100)
[REPLACED_LITERALS]
select with anonymization anon_count(* CLAMPED BETWEEN @_p0_INT64 AND @_p1_INT64)
from ProtoAnonymizationUid a, ProtoAnonymizationUid b

Rewrite ERROR: User id columns must support grouping, instead got type PROTO [at 2:6]
from ProtoAnonymizationUid a, ProtoAnonymizationUid b
     ^
==

# Support aggregation nested inside each side of a join
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from
  (select count(*), uid from SimpleTypesWithAnonymizationUid group by uid) a
  inner join
  (select count(*), uid from SimpleTypesWithAnonymizationUid group by uid) b
  on a.uid = b.uid;
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#29 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#29]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#29]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=[$aggregate.$agg1#13, $groupby.uid#14, $aggregate.$agg1#27, $groupby.uid#28]
        |   +-left_scan=
        |   | +-ProjectScan
        |   |   +-column_list=[$aggregate.$agg1#13, $groupby.uid#14]
        |   |   +-input_scan=
        |   |     +-AggregateScan
        |   |       +-column_list=[$groupby.uid#14, $aggregate.$agg1#13]
        |   |       +-input_scan=
        |   |       | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10])
        |   |       +-group_by_list=
        |   |       | +-uid#14 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   |       +-aggregate_list=
        |   |         +-$agg1#13 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        |   +-right_scan=
        |   | +-ProjectScan
        |   |   +-column_list=[$aggregate.$agg1#27, $groupby.uid#28]
        |   |   +-input_scan=
        |   |     +-AggregateScan
        |   |       +-column_list=[$groupby.uid#28, $aggregate.$agg1#27]
        |   |       +-input_scan=
        |   |       | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#25], table=SimpleTypesWithAnonymizationUid, column_index_list=[10])
        |   |       +-group_by_list=
        |   |       | +-uid#28 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#25)
        |   |       +-aggregate_list=
        |   |         +-$agg1#27 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(type=INT64, column=$groupby.uid#14)
        |       +-ColumnRef(type=INT64, column=$groupby.uid#28)
        +-aggregate_list=
          +-$agg1#29 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#29 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#29]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#29]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#31, $group_by.$uid#32]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-column_list=[$aggregate.$agg1#13, $groupby.uid#14, $aggregate.$agg1#27, $groupby.uid#28]
        |   |   +-left_scan=
        |   |   | +-ProjectScan
        |   |   |   +-column_list=[$aggregate.$agg1#13, $groupby.uid#14]
        |   |   |   +-input_scan=
        |   |   |     +-AggregateScan
        |   |   |       +-column_list=[$groupby.uid#14, $aggregate.$agg1#13]
        |   |   |       +-input_scan=
        |   |   |       | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10])
        |   |   |       +-group_by_list=
        |   |   |       | +-uid#14 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   |   |       +-aggregate_list=
        |   |   |         +-$agg1#13 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        |   |   +-right_scan=
        |   |   | +-ProjectScan
        |   |   |   +-column_list=[$aggregate.$agg1#27, $groupby.uid#28]
        |   |   |   +-input_scan=
        |   |   |     +-AggregateScan
        |   |   |       +-column_list=[$groupby.uid#28, $aggregate.$agg1#27]
        |   |   |       +-input_scan=
        |   |   |       | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#25], table=SimpleTypesWithAnonymizationUid, column_index_list=[10])
        |   |   |       +-group_by_list=
        |   |   |       | +-uid#28 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#25)
        |   |   |       +-aggregate_list=
        |   |   |         +-$agg1#27 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        |   |   +-join_expr=
        |   |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |       +-ColumnRef(type=INT64, column=$groupby.uid#14)
        |   |       +-ColumnRef(type=INT64, column=$groupby.uid#28)
        |   +-group_by_list=
        |   | +-$uid#32 := ColumnRef(type=INT64, column=$groupby.uid#14)
        |   +-aggregate_list=
        |     +-$agg1_partial#31 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
        | +-$agg1#29 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#31)
        | |   +-Literal(type=INT64, value=0)
        | |   +-Literal(type=INT64, value=100)
        | +-$k_threshold_col#35 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#35)

[TableScan Groups]
{
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10])
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#25], table=SimpleTypesWithAnonymizationUid, column_index_list=[10])
}
==

# Support aggregation nested inside one side of a join
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from
  SimpleTypesWithAnonymizationUid a
  inner join
  (select count(*), uid from SimpleTypesWithAnonymizationUid group by uid) b
  on a.uid = b.uid;
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#27 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#27]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#27]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=[SimpleTypesWithAnonymizationUid.uid#11, $aggregate.$agg1#25, $groupby.uid#26]
        |   +-left_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   +-right_scan=
        |   | +-ProjectScan
        |   |   +-column_list=[$aggregate.$agg1#25, $groupby.uid#26]
        |   |   +-input_scan=
        |   |     +-AggregateScan
        |   |       +-column_list=[$groupby.uid#26, $aggregate.$agg1#25]
        |   |       +-input_scan=
        |   |       | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10])
        |   |       +-group_by_list=
        |   |       | +-uid#26 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        |   |       +-aggregate_list=
        |   |         +-$agg1#25 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |       +-ColumnRef(type=INT64, column=$groupby.uid#26)
        +-aggregate_list=
          +-$agg1#27 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#27 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#27]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#27]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#29, $group_by.$uid#30]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-column_list=[SimpleTypesWithAnonymizationUid.uid#11, $aggregate.$agg1#25, $groupby.uid#26]
        |   |   +-left_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   |   +-right_scan=
        |   |   | +-ProjectScan
        |   |   |   +-column_list=[$aggregate.$agg1#25, $groupby.uid#26]
        |   |   |   +-input_scan=
        |   |   |     +-AggregateScan
        |   |   |       +-column_list=[$groupby.uid#26, $aggregate.$agg1#25]
        |   |   |       +-input_scan=
        |   |   |       | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10])
        |   |   |       +-group_by_list=
        |   |   |       | +-uid#26 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        |   |   |       +-aggregate_list=
        |   |   |         +-$agg1#25 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        |   |   +-join_expr=
        |   |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   |       +-ColumnRef(type=INT64, column=$groupby.uid#26)
        |   +-group_by_list=
        |   | +-$uid#30 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   +-aggregate_list=
        |     +-$agg1_partial#29 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
        | +-$agg1#27 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#29)
        | |   +-Literal(type=INT64, value=0)
        | |   +-Literal(type=INT64, value=100)
        | +-$k_threshold_col#33 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#33)

[TableScan Groups]
{
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10])
}
==

# Support aggregation nested inside both sides of a join, with one side
# querying a table with user data and the other not.
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from
  (select count(*), uid from SimpleTypesWithAnonymizationUid group by uid) a,
  (select count(*) from SimpleTypes) b;
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#34 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#34]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#34]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=[$aggregate.$agg1#13, $groupby.uid#14, $aggregate.$agg1#33]
        |   +-left_scan=
        |   | +-ProjectScan
        |   |   +-column_list=[$aggregate.$agg1#13, $groupby.uid#14]
        |   |   +-input_scan=
        |   |     +-AggregateScan
        |   |       +-column_list=[$groupby.uid#14, $aggregate.$agg1#13]
        |   |       +-input_scan=
        |   |       | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10])
        |   |       +-group_by_list=
        |   |       | +-uid#14 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   |       +-aggregate_list=
        |   |         +-$agg1#13 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        |   +-right_scan=
        |     +-ProjectScan
        |       +-column_list=[$aggregate.$agg1#33]
        |       +-input_scan=
        |         +-AggregateScan
        |           +-column_list=[$aggregate.$agg1#33]
        |           +-input_scan=
        |           | +-TableScan(table=SimpleTypes)
        |           +-aggregate_list=
        |             +-$agg1#33 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
          +-$agg1#34 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#34 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#34]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#34]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#36, $group_by.$uid#37]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-column_list=[$aggregate.$agg1#13, $groupby.uid#14, $aggregate.$agg1#33]
        |   |   +-left_scan=
        |   |   | +-ProjectScan
        |   |   |   +-column_list=[$aggregate.$agg1#13, $groupby.uid#14]
        |   |   |   +-input_scan=
        |   |   |     +-AggregateScan
        |   |   |       +-column_list=[$groupby.uid#14, $aggregate.$agg1#13]
        |   |   |       +-input_scan=
        |   |   |       | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10])
        |   |   |       +-group_by_list=
        |   |   |       | +-uid#14 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   |   |       +-aggregate_list=
        |   |   |         +-$agg1#13 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        |   |   +-right_scan=
        |   |     +-ProjectScan
        |   |       +-column_list=[$aggregate.$agg1#33]
        |   |       +-input_scan=
        |   |         +-AggregateScan
        |   |           +-column_list=[$aggregate.$agg1#33]
        |   |           +-input_scan=
        |   |           | +-TableScan(table=SimpleTypes)
        |   |           +-aggregate_list=
        |   |             +-$agg1#33 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        |   +-group_by_list=
        |   | +-$uid#37 := ColumnRef(type=INT64, column=$groupby.uid#14)
        |   +-aggregate_list=
        |     +-$agg1_partial#36 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
        | +-$agg1#34 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#36)
        | |   +-Literal(type=INT64, value=0)
        | |   +-Literal(type=INT64, value=100)
        | +-$k_threshold_col#40 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#40)

[TableScan Groups]
{
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10])
}
==

# A simple join+group by query.
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 100)
from SimpleTypesWithAnonymizationUid a, SimpleTypes b
group by b.int64;
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#31 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#31]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#31]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=[SimpleTypes.int64#14]
        |   +-left_scan=
        |   | +-TableScan(table=SimpleTypesWithAnonymizationUid, alias="a")
        |   +-right_scan=
        |     +-TableScan(column_list=[SimpleTypes.int64#14], table=SimpleTypes, column_index_list=[1], alias="b")
        +-group_by_list=
        | +-int64#32 := ColumnRef(type=INT64, column=SimpleTypes.int64#14)
        +-aggregate_list=
          +-$agg1#31 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=100)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#31 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#31]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#31]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#35, $groupby.int64_partial#36, $group_by.$uid#37]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-column_list=[SimpleTypes.int64#14, SimpleTypesWithAnonymizationUid.uid#33]
        |   |   +-left_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#33], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   |   +-right_scan=
        |   |     +-TableScan(column_list=[SimpleTypes.int64#14], table=SimpleTypes, column_index_list=[1], alias="b")
        |   +-group_by_list=
        |   | +-int64_partial#36 := ColumnRef(type=INT64, column=SimpleTypes.int64#14)
        |   | +-$uid#37 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#33)
        |   +-aggregate_list=
        |     +-$agg1_partial#35 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-group_by_list=
        | +-int64#32 := ColumnRef(type=INT64, column=$groupby.int64_partial#36)
        +-aggregate_list=
        | +-$agg1#31 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#35)
        | |   +-Literal(type=INT64, value=0)
        | |   +-Literal(type=INT64, value=100)
        | +-$k_threshold_col#40 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#40)

[TableScan Groups]
{
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#33], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
}
==

# string_val is the userid column for KitchenSinkWithUidValueTable
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
SELECT ANON_SUM(t1.int64_val)
FROM KitchenSinkWithUidValueTable t1
  LEFT OUTER JOIN KitchenSinkWithUidValueTable t2
  ON t1.string_val = t2.string_val;
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#3 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-151
    +-column_list=[$aggregate.$agg1#3]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#3]
        +-input_scan=
        | +-JoinScan
        |   +-parse_location=69-84
        |   +-column_list=KitchenSinkWithUidValueTable.[value#1, value#2]
        |   +-join_type=LEFT
        |   +-left_scan=
        |   | +-TableScan(parse_location=35-63, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t1")
        |   +-right_scan=
        |   | +-TableScan(parse_location=85-113, column_list=[KitchenSinkWithUidValueTable.value#2], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t2")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(STRING, STRING) -> BOOL)
        |       +-GetProtoField
        |       | +-parse_location=125-135
        |       | +-type=STRING
        |       | +-expr=
        |       | | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |       | +-field_descriptor=string_val
        |       | +-default_value="default_name"
        |       +-GetProtoField
        |         +-parse_location=141-151
        |         +-type=STRING
        |         +-expr=
        |         | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#2)
        |         +-field_descriptor=string_val
        |         +-default_value="default_name"
        +-aggregate_list=
          +-$agg1#3 :=
            +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(0) INT64, optional(0) INT64) -> INT64)
              +-parse_location=7-15
              +-GetProtoField
                +-parse_location=19-28
                +-type=INT64
                +-expr=
                | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
                +-field_descriptor=int64_val
                +-default_value=0
[REPLACED_LITERALS]
SELECT ANON_SUM(t1.int64_val)
FROM KitchenSinkWithUidValueTable t1
  LEFT OUTER JOIN KitchenSinkWithUidValueTable t2
  ON t1.string_val = t2.string_val;

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#3 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-151
    +-column_list=[$aggregate.$agg1#3]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#3]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#7, $group_by.$uid#8]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-parse_location=69-84
        |   |   +-column_list=[KitchenSinkWithUidValueTable.value#1, KitchenSinkWithUidValueTable.value#2, $project.$string_val#4]
        |   |   +-join_type=LEFT
        |   |   +-left_scan=
        |   |   | +-ProjectScan
        |   |   |   +-column_list=[KitchenSinkWithUidValueTable.value#1, $project.$string_val#4]
        |   |   |   +-expr_list=
        |   |   |   | +-$string_val#4 :=
        |   |   |   |   +-GetProtoField
        |   |   |   |     +-type=STRING
        |   |   |   |     +-expr=
        |   |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |   |   |     +-field_descriptor=string_val
        |   |   |   |     +-default_value="default_name"
        |   |   |   +-input_scan=
        |   |   |     +-TableScan(parse_location=35-63, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t1")
        |   |   +-right_scan=
        |   |   | +-ProjectScan
        |   |   |   +-column_list=[KitchenSinkWithUidValueTable.value#2, $project.$string_val#5]
        |   |   |   +-expr_list=
        |   |   |   | +-$string_val#5 :=
        |   |   |   |   +-GetProtoField
        |   |   |   |     +-type=STRING
        |   |   |   |     +-expr=
        |   |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#2)
        |   |   |   |     +-field_descriptor=string_val
        |   |   |   |     +-default_value="default_name"
        |   |   |   +-input_scan=
        |   |   |     +-TableScan(parse_location=85-113, column_list=[KitchenSinkWithUidValueTable.value#2], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t2")
        |   |   +-join_expr=
        |   |     +-FunctionCall(ZetaSQL:$equal(STRING, STRING) -> BOOL)
        |   |       +-GetProtoField
        |   |       | +-parse_location=125-135
        |   |       | +-type=STRING
        |   |       | +-expr=
        |   |       | | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |       | +-field_descriptor=string_val
        |   |       | +-default_value="default_name"
        |   |       +-GetProtoField
        |   |         +-parse_location=141-151
        |   |         +-type=STRING
        |   |         +-expr=
        |   |         | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#2)
        |   |         +-field_descriptor=string_val
        |   |         +-default_value="default_name"
        |   +-group_by_list=
        |   | +-$uid#8 := ColumnRef(type=STRING, column=$project.$string_val#4)
        |   +-aggregate_list=
        |     +-$agg1_partial#7 :=
        |       +-AggregateFunctionCall(ZetaSQL:sum(INT64) -> INT64)
        |         +-GetProtoField
        |           +-parse_location=19-28
        |           +-type=INT64
        |           +-expr=
        |           | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |           +-field_descriptor=int64_val
        |           +-default_value=0
        +-aggregate_list=
        | +-$agg1#3 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(0) INT64, optional(0) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#7)
        | +-$k_threshold_col#11 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#11)

[TableScan Groups]
{
  TableScan(parse_location=35-63, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t1")
  TableScan(parse_location=85-113, column_list=[KitchenSinkWithUidValueTable.value#2], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t2")
}
==

# string_val is the userid column for KitchenSinkWithUidValueTable
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
SELECT ANON_SUM(n)
FROM
  (
    SELECT t1.string_val, t1.int64_val AS n
    FROM KitchenSinkWithUidValueTable t1
    JOIN KitchenSinkWithUidValueTable t2
      ON t1.string_val = t2.string_val
    WHERE MOD(t1.int32_val, 2) = 0
  );
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#5 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-231
    +-column_list=[$aggregate.$agg1#5]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#5]
        +-input_scan=
        | +-ProjectScan
        |   +-parse_location=32-227
        |   +-column_list=$subquery1.[string_val#3, n#4]
        |   +-expr_list=
        |   | +-string_val#3 :=
        |   | | +-GetProtoField
        |   | |   +-parse_location=42-52
        |   | |   +-type=STRING
        |   | |   +-expr=
        |   | |   | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   | |   +-field_descriptor=string_val
        |   | |   +-default_value="default_name"
        |   | +-n#4 :=
        |   |   +-GetProtoField
        |   |     +-parse_location=57-66
        |   |     +-type=INT64
        |   |     +-expr=
        |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |     +-field_descriptor=int64_val
        |   |     +-default_value=0
        |   +-input_scan=
        |     +-FilterScan
        |       +-column_list=KitchenSinkWithUidValueTable.[value#1, value#2]
        |       +-input_scan=
        |       | +-JoinScan
        |       |   +-parse_location=117-121
        |       |   +-column_list=KitchenSinkWithUidValueTable.[value#1, value#2]
        |       |   +-left_scan=
        |       |   | +-TableScan(parse_location=81-109, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t1")
        |       |   +-right_scan=
        |       |   | +-TableScan(parse_location=122-150, column_list=[KitchenSinkWithUidValueTable.value#2], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t2")
        |       |   +-join_expr=
        |       |     +-FunctionCall(ZetaSQL:$equal(STRING, STRING) -> BOOL)
        |       |       +-GetProtoField
        |       |       | +-parse_location=166-176
        |       |       | +-type=STRING
        |       |       | +-expr=
        |       |       | | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |       |       | +-field_descriptor=string_val
        |       |       | +-default_value="default_name"
        |       |       +-GetProtoField
        |       |         +-parse_location=182-192
        |       |         +-type=STRING
        |       |         +-expr=
        |       |         | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#2)
        |       |         +-field_descriptor=string_val
        |       |         +-default_value="default_name"
        |       +-filter_expr=
        |         +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |           +-FunctionCall(ZetaSQL:mod(INT64, INT64) -> INT64)
        |           | +-parse_location=203-206
        |           | +-Cast(INT32 -> INT64)
        |           | | +-GetProtoField
        |           | |   +-parse_location=210-219
        |           | |   +-type=INT32
        |           | |   +-expr=
        |           | |   | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |           | |   +-field_descriptor=int32_val
        |           | |   +-default_value=77
        |           | +-Literal(parse_location=221-222, type=INT64, value=2)
        |           +-Literal(parse_location=226-227, type=INT64, value=0)
        +-aggregate_list=
          +-$agg1#5 :=
            +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(0) INT64, optional(0) INT64) -> INT64)
              +-parse_location=7-15
              +-ColumnRef(parse_location=16-17, type=INT64, column=$subquery1.n#4)
[REPLACED_LITERALS]
SELECT ANON_SUM(n)
FROM
  (
    SELECT t1.string_val, t1.int64_val AS n
    FROM KitchenSinkWithUidValueTable t1
    JOIN KitchenSinkWithUidValueTable t2
      ON t1.string_val = t2.string_val
    WHERE MOD(t1.int32_val, @_p0_INT64) = @_p1_INT64
  );

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#5 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-231
    +-column_list=[$aggregate.$agg1#5]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#5]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#9, $group_by.$uid#10]
        |   +-input_scan=
        |   | +-ProjectScan
        |   |   +-parse_location=32-227
        |   |   +-column_list=$subquery1.[string_val#3, n#4]
        |   |   +-expr_list=
        |   |   | +-string_val#3 := ColumnRef(type=STRING, column=$project.$string_val#6)
        |   |   | +-n#4 :=
        |   |   |   +-GetProtoField
        |   |   |     +-parse_location=57-66
        |   |   |     +-type=INT64
        |   |   |     +-expr=
        |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |   |     +-field_descriptor=int64_val
        |   |   |     +-default_value=0
        |   |   +-input_scan=
        |   |     +-FilterScan
        |   |       +-column_list=[KitchenSinkWithUidValueTable.value#1, KitchenSinkWithUidValueTable.value#2, $project.$string_val#6]
        |   |       +-input_scan=
        |   |       | +-JoinScan
        |   |       |   +-parse_location=117-121
        |   |       |   +-column_list=[KitchenSinkWithUidValueTable.value#1, KitchenSinkWithUidValueTable.value#2, $project.$string_val#6]
        |   |       |   +-left_scan=
        |   |       |   | +-ProjectScan
        |   |       |   |   +-column_list=[KitchenSinkWithUidValueTable.value#1, $project.$string_val#6]
        |   |       |   |   +-expr_list=
        |   |       |   |   | +-$string_val#6 :=
        |   |       |   |   |   +-GetProtoField
        |   |       |   |   |     +-type=STRING
        |   |       |   |   |     +-expr=
        |   |       |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |       |   |   |     +-field_descriptor=string_val
        |   |       |   |   |     +-default_value="default_name"
        |   |       |   |   +-input_scan=
        |   |       |   |     +-TableScan(parse_location=81-109, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t1")
        |   |       |   +-right_scan=
        |   |       |   | +-ProjectScan
        |   |       |   |   +-column_list=[KitchenSinkWithUidValueTable.value#2, $project.$string_val#7]
        |   |       |   |   +-expr_list=
        |   |       |   |   | +-$string_val#7 :=
        |   |       |   |   |   +-GetProtoField
        |   |       |   |   |     +-type=STRING
        |   |       |   |   |     +-expr=
        |   |       |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#2)
        |   |       |   |   |     +-field_descriptor=string_val
        |   |       |   |   |     +-default_value="default_name"
        |   |       |   |   +-input_scan=
        |   |       |   |     +-TableScan(parse_location=122-150, column_list=[KitchenSinkWithUidValueTable.value#2], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t2")
        |   |       |   +-join_expr=
        |   |       |     +-FunctionCall(ZetaSQL:$equal(STRING, STRING) -> BOOL)
        |   |       |       +-GetProtoField
        |   |       |       | +-parse_location=166-176
        |   |       |       | +-type=STRING
        |   |       |       | +-expr=
        |   |       |       | | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |       |       | +-field_descriptor=string_val
        |   |       |       | +-default_value="default_name"
        |   |       |       +-GetProtoField
        |   |       |         +-parse_location=182-192
        |   |       |         +-type=STRING
        |   |       |         +-expr=
        |   |       |         | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#2)
        |   |       |         +-field_descriptor=string_val
        |   |       |         +-default_value="default_name"
        |   |       +-filter_expr=
        |   |         +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |           +-FunctionCall(ZetaSQL:mod(INT64, INT64) -> INT64)
        |   |           | +-parse_location=203-206
        |   |           | +-Cast(INT32 -> INT64)
        |   |           | | +-GetProtoField
        |   |           | |   +-parse_location=210-219
        |   |           | |   +-type=INT32
        |   |           | |   +-expr=
        |   |           | |   | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |           | |   +-field_descriptor=int32_val
        |   |           | |   +-default_value=77
        |   |           | +-Literal(parse_location=221-222, type=INT64, value=2)
        |   |           +-Literal(parse_location=226-227, type=INT64, value=0)
        |   +-group_by_list=
        |   | +-$uid#10 := ColumnRef(type=STRING, column=$subquery1.string_val#3)
        |   +-aggregate_list=
        |     +-$agg1_partial#9 :=
        |       +-AggregateFunctionCall(ZetaSQL:sum(INT64) -> INT64)
        |         +-ColumnRef(parse_location=16-17, type=INT64, column=$subquery1.n#4)
        +-aggregate_list=
        | +-$agg1#5 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(0) INT64, optional(0) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#9)
        | +-$k_threshold_col#13 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#13)

[TableScan Groups]
{
  TableScan(parse_location=122-150, column_list=[KitchenSinkWithUidValueTable.value#2], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t2")
  TableScan(parse_location=81-109, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t1")
}
==

# Inner joins always use the left table as the userid, using the right table
# userid is currently rejected even though it is semantically valid.
# string_val is the userid column for KitchenSinkWithUidValueTable
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
SELECT ANON_COUNT(*)
FROM
  (
    SELECT t2.string_val
    FROM KitchenSinkWithUidValueTable t1
    JOIN KitchenSinkWithUidValueTable t2
      ON t1.string_val = t2.string_val
    WHERE 1=1
  );
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#4 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-193
    +-column_list=[$aggregate.$agg1#4]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#4]
        +-input_scan=
        | +-ProjectScan
        |   +-parse_location=34-189
        |   +-column_list=[$subquery1.string_val#3]
        |   +-expr_list=
        |   | +-string_val#3 :=
        |   |   +-GetProtoField
        |   |     +-parse_location=44-54
        |   |     +-type=STRING
        |   |     +-expr=
        |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#2)
        |   |     +-field_descriptor=string_val
        |   |     +-default_value="default_name"
        |   +-input_scan=
        |     +-FilterScan
        |       +-column_list=KitchenSinkWithUidValueTable.[value#1, value#2]
        |       +-input_scan=
        |       | +-JoinScan
        |       |   +-parse_location=100-104
        |       |   +-column_list=KitchenSinkWithUidValueTable.[value#1, value#2]
        |       |   +-left_scan=
        |       |   | +-TableScan(parse_location=64-92, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t1")
        |       |   +-right_scan=
        |       |   | +-TableScan(parse_location=105-133, column_list=[KitchenSinkWithUidValueTable.value#2], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t2")
        |       |   +-join_expr=
        |       |     +-FunctionCall(ZetaSQL:$equal(STRING, STRING) -> BOOL)
        |       |       +-GetProtoField
        |       |       | +-parse_location=149-159
        |       |       | +-type=STRING
        |       |       | +-expr=
        |       |       | | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |       |       | +-field_descriptor=string_val
        |       |       | +-default_value="default_name"
        |       |       +-GetProtoField
        |       |         +-parse_location=165-175
        |       |         +-type=STRING
        |       |         +-expr=
        |       |         | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#2)
        |       |         +-field_descriptor=string_val
        |       |         +-default_value="default_name"
        |       +-filter_expr=
        |         +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |           +-Literal(parse_location=186-187, type=INT64, value=1)
        |           +-Literal(parse_location=188-189, type=INT64, value=1)
        +-aggregate_list=
          +-$agg1#4 := AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(0) INT64, optional(0) INT64) -> INT64)(parse_location=7-17)
[REPLACED_LITERALS]
SELECT ANON_COUNT(*)
FROM
  (
    SELECT t2.string_val
    FROM KitchenSinkWithUidValueTable t1
    JOIN KitchenSinkWithUidValueTable t2
      ON t1.string_val = t2.string_val
    WHERE @_p0_INT64=@_p1_INT64
  );

Rewrite ERROR: Subqueries of anonymization queries must explicitly SELECT the userid column 't1.value.string_val' [at 4:5]
    SELECT t2.string_val
    ^
==

# string_val is the userid column for KitchenSinkWithUidValueTable
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
SELECT ANON_COUNT(*)
FROM KitchenSinkWithUidValueTable t1
JOIN KitchenSinkWithUidValueTable t2
  USING(string_val)
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#5 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-114
    +-column_list=[$aggregate.$agg1#5]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#5]
        +-input_scan=
        | +-JoinScan
        |   +-parse_location=58-62
        |   +-column_list=[KitchenSinkWithUidValueTable.value#1, $join_left.string_val#3, KitchenSinkWithUidValueTable.value#2, $join_right.string_val#4]
        |   +-left_scan=
        |   | +-ProjectScan
        |   |   +-column_list=[KitchenSinkWithUidValueTable.value#1, $join_left.string_val#3]
        |   |   +-expr_list=
        |   |   | +-string_val#3 :=
        |   |   |   +-GetProtoField
        |   |   |     +-parse_location=103-113
        |   |   |     +-type=STRING
        |   |   |     +-expr=
        |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |   |     +-field_descriptor=string_val
        |   |   |     +-default_value="default_name"
        |   |   +-input_scan=
        |   |     +-TableScan(parse_location=26-54, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t1")
        |   +-right_scan=
        |   | +-ProjectScan
        |   |   +-column_list=[KitchenSinkWithUidValueTable.value#2, $join_right.string_val#4]
        |   |   +-expr_list=
        |   |   | +-string_val#4 :=
        |   |   |   +-GetProtoField
        |   |   |     +-parse_location=103-113
        |   |   |     +-type=STRING
        |   |   |     +-expr=
        |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#2)
        |   |   |     +-field_descriptor=string_val
        |   |   |     +-default_value="default_name"
        |   |   +-input_scan=
        |   |     +-TableScan(parse_location=63-91, column_list=[KitchenSinkWithUidValueTable.value#2], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t2")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(STRING, STRING) -> BOOL)
        |       +-ColumnRef(type=STRING, column=$join_left.string_val#3)
        |       +-ColumnRef(type=STRING, column=$join_right.string_val#4)
        +-aggregate_list=
          +-$agg1#5 := AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(0) INT64, optional(0) INT64) -> INT64)(parse_location=7-17)
[REPLACED_LITERALS]
SELECT ANON_COUNT(*)
FROM KitchenSinkWithUidValueTable t1
JOIN KitchenSinkWithUidValueTable t2
  USING(string_val)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#5 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-114
    +-column_list=[$aggregate.$agg1#5]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#5]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#9, $group_by.$uid#10]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-parse_location=58-62
        |   |   +-column_list=[KitchenSinkWithUidValueTable.value#1, $join_left.string_val#3, KitchenSinkWithUidValueTable.value#2, $join_right.string_val#4]
        |   |   +-left_scan=
        |   |   | +-ProjectScan
        |   |   |   +-column_list=[KitchenSinkWithUidValueTable.value#1, $join_left.string_val#3]
        |   |   |   +-expr_list=
        |   |   |   | +-string_val#3 := ColumnRef(type=STRING, column=$project.$string_val#6)
        |   |   |   +-input_scan=
        |   |   |     +-ProjectScan
        |   |   |       +-column_list=[KitchenSinkWithUidValueTable.value#1, $project.$string_val#6]
        |   |   |       +-expr_list=
        |   |   |       | +-$string_val#6 :=
        |   |   |       |   +-GetProtoField
        |   |   |       |     +-type=STRING
        |   |   |       |     +-expr=
        |   |   |       |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |   |       |     +-field_descriptor=string_val
        |   |   |       |     +-default_value="default_name"
        |   |   |       +-input_scan=
        |   |   |         +-TableScan(parse_location=26-54, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t1")
        |   |   +-right_scan=
        |   |   | +-ProjectScan
        |   |   |   +-column_list=[KitchenSinkWithUidValueTable.value#2, $join_right.string_val#4]
        |   |   |   +-expr_list=
        |   |   |   | +-string_val#4 := ColumnRef(type=STRING, column=$project.$string_val#7)
        |   |   |   +-input_scan=
        |   |   |     +-ProjectScan
        |   |   |       +-column_list=[KitchenSinkWithUidValueTable.value#2, $project.$string_val#7]
        |   |   |       +-expr_list=
        |   |   |       | +-$string_val#7 :=
        |   |   |       |   +-GetProtoField
        |   |   |       |     +-type=STRING
        |   |   |       |     +-expr=
        |   |   |       |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#2)
        |   |   |       |     +-field_descriptor=string_val
        |   |   |       |     +-default_value="default_name"
        |   |   |       +-input_scan=
        |   |   |         +-TableScan(parse_location=63-91, column_list=[KitchenSinkWithUidValueTable.value#2], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t2")
        |   |   +-join_expr=
        |   |     +-FunctionCall(ZetaSQL:$equal(STRING, STRING) -> BOOL)
        |   |       +-ColumnRef(type=STRING, column=$join_left.string_val#3)
        |   |       +-ColumnRef(type=STRING, column=$join_right.string_val#4)
        |   +-group_by_list=
        |   | +-$uid#10 := ColumnRef(type=STRING, column=$join_left.string_val#3)
        |   +-aggregate_list=
        |     +-$agg1_partial#9 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
        | +-$agg1#5 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(0) INT64, optional(0) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#9)
        | +-$k_threshold_col#13 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#13)

[TableScan Groups]
{
  TableScan(parse_location=26-54, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t1")
  TableScan(parse_location=63-91, column_list=[KitchenSinkWithUidValueTable.value#2], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t2")
}
==

# Reject USING clause on the wrong column
# string_val is the userid column for KitchenSinkWithUidValueTable
# TODO: The error message should complain about the join being
# wrong, rather than the userid column not being projected
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
SELECT ANON_COUNT(*)
FROM KitchenSinkWithUidValueTable t1
JOIN KitchenSinkWithUidValueTable t2
  USING(int64_val)
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#5 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-113
    +-column_list=[$aggregate.$agg1#5]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#5]
        +-input_scan=
        | +-JoinScan
        |   +-parse_location=58-62
        |   +-column_list=[KitchenSinkWithUidValueTable.value#1, $join_left.int64_val#3, KitchenSinkWithUidValueTable.value#2, $join_right.int64_val#4]
        |   +-left_scan=
        |   | +-ProjectScan
        |   |   +-column_list=[KitchenSinkWithUidValueTable.value#1, $join_left.int64_val#3]
        |   |   +-expr_list=
        |   |   | +-int64_val#3 :=
        |   |   |   +-GetProtoField
        |   |   |     +-parse_location=103-112
        |   |   |     +-type=INT64
        |   |   |     +-expr=
        |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |   |     +-field_descriptor=int64_val
        |   |   |     +-default_value=0
        |   |   +-input_scan=
        |   |     +-TableScan(parse_location=26-54, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t1")
        |   +-right_scan=
        |   | +-ProjectScan
        |   |   +-column_list=[KitchenSinkWithUidValueTable.value#2, $join_right.int64_val#4]
        |   |   +-expr_list=
        |   |   | +-int64_val#4 :=
        |   |   |   +-GetProtoField
        |   |   |     +-parse_location=103-112
        |   |   |     +-type=INT64
        |   |   |     +-expr=
        |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#2)
        |   |   |     +-field_descriptor=int64_val
        |   |   |     +-default_value=0
        |   |   +-input_scan=
        |   |     +-TableScan(parse_location=63-91, column_list=[KitchenSinkWithUidValueTable.value#2], table=KitchenSinkWithUidValueTable, column_index_list=[0], alias="t2")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(type=INT64, column=$join_left.int64_val#3)
        |       +-ColumnRef(type=INT64, column=$join_right.int64_val#4)
        +-aggregate_list=
          +-$agg1#5 := AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(0) INT64, optional(0) INT64) -> INT64)(parse_location=7-17)
[REPLACED_LITERALS]
SELECT ANON_COUNT(*)
FROM KitchenSinkWithUidValueTable t1
JOIN KitchenSinkWithUidValueTable t2
  USING(int64_val)

Rewrite ERROR: Subqueries of anonymization queries must explicitly SELECT the userid column 't1.value.string_val' [at 1:1]
SELECT ANON_COUNT(*)
^
==

# Allow USING on explicitly projected userid column
# string_val is the userid column for KitchenSinkWithUidValueTable
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
SELECT ANON_COUNT(*)
FROM (SELECT string_val as x, string_val as y FROM KitchenSinkWithUidValueTable) t1
JOIN (SELECT string_val as x, string_val as y FROM KitchenSinkWithUidValueTable) t2
  USING(x)
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#7 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-199
    +-column_list=[$aggregate.$agg1#7]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#7]
        +-input_scan=
        | +-JoinScan
        |   +-parse_location=105-109
        |   +-column_list=[t1.x#2, t1.y#3, t2.x#5, t2.y#6]
        |   +-left_scan=
        |   | +-ProjectScan
        |   |   +-parse_location=27-100
        |   |   +-column_list=t1.[x#2, y#3]
        |   |   +-expr_list=
        |   |   | +-x#2 :=
        |   |   | | +-GetProtoField
        |   |   | |   +-parse_location=34-44
        |   |   | |   +-type=STRING
        |   |   | |   +-expr=
        |   |   | |   | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |   | |   +-field_descriptor=string_val
        |   |   | |   +-default_value="default_name"
        |   |   | +-y#3 :=
        |   |   |   +-GetProtoField
        |   |   |     +-parse_location=51-61
        |   |   |     +-type=STRING
        |   |   |     +-expr=
        |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |   |     +-field_descriptor=string_val
        |   |   |     +-default_value="default_name"
        |   |   +-input_scan=
        |   |     +-TableScan(parse_location=72-100, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0])
        |   +-right_scan=
        |   | +-ProjectScan
        |   |   +-parse_location=111-184
        |   |   +-column_list=t2.[x#5, y#6]
        |   |   +-expr_list=
        |   |   | +-x#5 :=
        |   |   | | +-GetProtoField
        |   |   | |   +-parse_location=118-128
        |   |   | |   +-type=STRING
        |   |   | |   +-expr=
        |   |   | |   | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#4)
        |   |   | |   +-field_descriptor=string_val
        |   |   | |   +-default_value="default_name"
        |   |   | +-y#6 :=
        |   |   |   +-GetProtoField
        |   |   |     +-parse_location=135-145
        |   |   |     +-type=STRING
        |   |   |     +-expr=
        |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#4)
        |   |   |     +-field_descriptor=string_val
        |   |   |     +-default_value="default_name"
        |   |   +-input_scan=
        |   |     +-TableScan(parse_location=156-184, column_list=[KitchenSinkWithUidValueTable.value#4], table=KitchenSinkWithUidValueTable, column_index_list=[0])
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(STRING, STRING) -> BOOL)
        |       +-ColumnRef(type=STRING, column=t1.x#2)
        |       +-ColumnRef(type=STRING, column=t2.x#5)
        +-aggregate_list=
          +-$agg1#7 := AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(0) INT64, optional(0) INT64) -> INT64)(parse_location=7-17)
[REPLACED_LITERALS]
SELECT ANON_COUNT(*)
FROM (SELECT string_val as x, string_val as y FROM KitchenSinkWithUidValueTable) t1
JOIN (SELECT string_val as x, string_val as y FROM KitchenSinkWithUidValueTable) t2
  USING(x)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#7 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-199
    +-column_list=[$aggregate.$agg1#7]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#7]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#11, $group_by.$uid#12]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-parse_location=105-109
        |   |   +-column_list=[t1.x#2, t1.y#3, t2.x#5, t2.y#6]
        |   |   +-left_scan=
        |   |   | +-ProjectScan
        |   |   |   +-parse_location=27-100
        |   |   |   +-column_list=t1.[x#2, y#3]
        |   |   |   +-expr_list=
        |   |   |   | +-x#2 := ColumnRef(type=STRING, column=$project.$string_val#8)
        |   |   |   | +-y#3 :=
        |   |   |   |   +-GetProtoField
        |   |   |   |     +-parse_location=51-61
        |   |   |   |     +-type=STRING
        |   |   |   |     +-expr=
        |   |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |   |   |     +-field_descriptor=string_val
        |   |   |   |     +-default_value="default_name"
        |   |   |   +-input_scan=
        |   |   |     +-ProjectScan
        |   |   |       +-column_list=[KitchenSinkWithUidValueTable.value#1, $project.$string_val#8]
        |   |   |       +-expr_list=
        |   |   |       | +-$string_val#8 :=
        |   |   |       |   +-GetProtoField
        |   |   |       |     +-type=STRING
        |   |   |       |     +-expr=
        |   |   |       |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |   |       |     +-field_descriptor=string_val
        |   |   |       |     +-default_value="default_name"
        |   |   |       +-input_scan=
        |   |   |         +-TableScan(parse_location=72-100, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0])
        |   |   +-right_scan=
        |   |   | +-ProjectScan
        |   |   |   +-parse_location=111-184
        |   |   |   +-column_list=t2.[x#5, y#6]
        |   |   |   +-expr_list=
        |   |   |   | +-x#5 := ColumnRef(type=STRING, column=$project.$string_val#9)
        |   |   |   | +-y#6 :=
        |   |   |   |   +-GetProtoField
        |   |   |   |     +-parse_location=135-145
        |   |   |   |     +-type=STRING
        |   |   |   |     +-expr=
        |   |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#4)
        |   |   |   |     +-field_descriptor=string_val
        |   |   |   |     +-default_value="default_name"
        |   |   |   +-input_scan=
        |   |   |     +-ProjectScan
        |   |   |       +-column_list=[KitchenSinkWithUidValueTable.value#4, $project.$string_val#9]
        |   |   |       +-expr_list=
        |   |   |       | +-$string_val#9 :=
        |   |   |       |   +-GetProtoField
        |   |   |       |     +-type=STRING
        |   |   |       |     +-expr=
        |   |   |       |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#4)
        |   |   |       |     +-field_descriptor=string_val
        |   |   |       |     +-default_value="default_name"
        |   |   |       +-input_scan=
        |   |   |         +-TableScan(parse_location=156-184, column_list=[KitchenSinkWithUidValueTable.value#4], table=KitchenSinkWithUidValueTable, column_index_list=[0])
        |   |   +-join_expr=
        |   |     +-FunctionCall(ZetaSQL:$equal(STRING, STRING) -> BOOL)
        |   |       +-ColumnRef(type=STRING, column=t1.x#2)
        |   |       +-ColumnRef(type=STRING, column=t2.x#5)
        |   +-group_by_list=
        |   | +-$uid#12 := ColumnRef(type=STRING, column=t1.x#2)
        |   +-aggregate_list=
        |     +-$agg1_partial#11 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
        | +-$agg1#7 :=
        | | +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(0) INT64, optional(0) INT64) -> INT64)
        | |   +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#11)
        | +-$k_threshold_col#15 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-Literal(type=INT64, value=1)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$anon.$k_threshold_col#15)

[TableScan Groups]
{
  TableScan(parse_location=156-184, column_list=[KitchenSinkWithUidValueTable.value#4], table=KitchenSinkWithUidValueTable, column_index_list=[0])
  TableScan(parse_location=72-100, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0])
}
==

# TODO: Allow equivalent userid columns to be used interchangeably
# string_val is the userid column for KitchenSinkWithUidValueTable
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
[parse_location_record_type=PARSE_LOCATION_RECORD_CODE_SEARCH]
SELECT ANON_COUNT(*)
FROM (SELECT string_val as x, string_val as y FROM KitchenSinkWithUidValueTable) t1
JOIN (SELECT string_val as x, string_val as y FROM KitchenSinkWithUidValueTable) t2
  USING(y)
--
[PRE-REWRITE AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#7 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-parse_location=0-199
    +-column_list=[$aggregate.$agg1#7]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#7]
        +-input_scan=
        | +-JoinScan
        |   +-parse_location=105-109
        |   +-column_list=[t1.x#2, t1.y#3, t2.x#5, t2.y#6]
        |   +-left_scan=
        |   | +-ProjectScan
        |   |   +-parse_location=27-100
        |   |   +-column_list=t1.[x#2, y#3]
        |   |   +-expr_list=
        |   |   | +-x#2 :=
        |   |   | | +-GetProtoField
        |   |   | |   +-parse_location=34-44
        |   |   | |   +-type=STRING
        |   |   | |   +-expr=
        |   |   | |   | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |   | |   +-field_descriptor=string_val
        |   |   | |   +-default_value="default_name"
        |   |   | +-y#3 :=
        |   |   |   +-GetProtoField
        |   |   |     +-parse_location=51-61
        |   |   |     +-type=STRING
        |   |   |     +-expr=
        |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#1)
        |   |   |     +-field_descriptor=string_val
        |   |   |     +-default_value="default_name"
        |   |   +-input_scan=
        |   |     +-TableScan(parse_location=72-100, column_list=[KitchenSinkWithUidValueTable.value#1], table=KitchenSinkWithUidValueTable, column_index_list=[0])
        |   +-right_scan=
        |   | +-ProjectScan
        |   |   +-parse_location=111-184
        |   |   +-column_list=t2.[x#5, y#6]
        |   |   +-expr_list=
        |   |   | +-x#5 :=
        |   |   | | +-GetProtoField
        |   |   | |   +-parse_location=118-128
        |   |   | |   +-type=STRING
        |   |   | |   +-expr=
        |   |   | |   | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#4)
        |   |   | |   +-field_descriptor=string_val
        |   |   | |   +-default_value="default_name"
        |   |   | +-y#6 :=
        |   |   |   +-GetProtoField
        |   |   |     +-parse_location=135-145
        |   |   |     +-type=STRING
        |   |   |     +-expr=
        |   |   |     | +-ColumnRef(type=PROTO<zetasql_test__.KitchenSinkPB>, column=KitchenSinkWithUidValueTable.value#4)
        |   |   |     +-field_descriptor=string_val
        |   |   |     +-default_value="default_name"
        |   |   +-input_scan=
        |   |     +-TableScan(parse_location=156-184, column_list=[KitchenSinkWithUidValueTable.value#4], table=KitchenSinkWithUidValueTable, column_index_list=[0])
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(STRING, STRING) -> BOOL)
        |       +-ColumnRef(type=STRING, column=t1.y#3)
        |       +-ColumnRef(type=STRING, column=t2.y#6)
        +-aggregate_list=
          +-$agg1#7 := AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(0) INT64, optional(0) INT64) -> INT64)(parse_location=7-17)
[REPLACED_LITERALS]
SELECT ANON_COUNT(*)
FROM (SELECT string_val as x, string_val as y FROM KitchenSinkWithUidValueTable) t1
JOIN (SELECT string_val as x, string_val as y FROM KitchenSinkWithUidValueTable) t2
  USING(y)

Rewrite ERROR: Joins between tables containing private data must also explicitly join on the user id column in each table, add 'AND t1.x=t2.x' to the join ON expression [at 1:1]
SELECT ANON_COUNT(*)
^
==

# Count (*) counting unique users.
# ANONYMIZATION_THRESHOLDING feature is enabled, therefore we should use this
# count for k_threshold.
[language_features=ANONYMIZATION,TABLE_VALUED_FUNCTIONS,TEMPLATE_FUNCTIONS,CREATE_TABLE_FUNCTION,ANONYMIZATION_THRESHOLDING]
[enabled_ast_rewrites=DEFAULTS,+ANONYMIZATION]
select with anonymization anon_count(* CLAMPED BETWEEN 0 AND 1)
from SimpleTypesWithAnonymizationUid a
inner join SimpleTypesWithAnonymizationUid b on a.uid = b.uid;
--
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-JoinScan
        |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   +-left_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   +-right_scan=
        |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   +-join_expr=
        |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        +-aggregate_list=
          +-$agg1#25 :=
            +-AggregateFunctionCall(ZetaSQL:$anon_count_star(optional(1) INT64, optional(1) INT64) -> INT64)
              +-Literal(type=INT64, value=0)
              +-Literal(type=INT64, value=1)

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$aggregate.$agg1#25 AS `$col1` [INT64]
+-query=
  +-ProjectScan
    +-column_list=[$aggregate.$agg1#25]
    +-input_scan=
      +-AnonymizedAggregateScan
        +-column_list=[$aggregate.$agg1#25]
        +-input_scan=
        | +-AggregateScan
        |   +-column_list=[$aggregate.$agg1_partial#27, $group_by.$uid#28]
        |   +-input_scan=
        |   | +-JoinScan
        |   |   +-column_list=SimpleTypesWithAnonymizationUid.[uid#11, uid#23]
        |   |   +-left_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
        |   |   +-right_scan=
        |   |   | +-TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
        |   |   +-join_expr=
        |   |     +-FunctionCall(ZetaSQL:$equal(INT64, INT64) -> BOOL)
        |   |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   |       +-ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#23)
        |   +-group_by_list=
        |   | +-$uid#28 := ColumnRef(type=INT64, column=SimpleTypesWithAnonymizationUid.uid#11)
        |   +-aggregate_list=
        |     +-$agg1_partial#27 := AggregateFunctionCall(ZetaSQL:$count_star() -> INT64)
        +-aggregate_list=
        | +-$agg1#25 :=
        |   +-AggregateFunctionCall(ZetaSQL:anon_sum(INT64, optional(1) INT64, optional(1) INT64) -> INT64)
        |     +-ColumnRef(type=INT64, column=$aggregate.$agg1_partial#27)
        |     +-Literal(type=INT64, value=0)
        |     +-Literal(type=INT64, value=1)
        +-k_threshold_expr=
          +-ColumnRef(type=INT64, column=$aggregate.$agg1#25)

[TableScan Groups]
{
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#11], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="a")
  TableScan(column_list=[SimpleTypesWithAnonymizationUid.uid#23], table=SimpleTypesWithAnonymizationUid, column_index_list=[10], alias="b")
}
