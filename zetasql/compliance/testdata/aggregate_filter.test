[default required_features=AGGREGATE_FILTERING]

[prepare_database]
CREATE TABLE Employees AS
  SELECT * FROM UNNEST([
    STRUCT(1 AS emp_id, 101 AS dept_id, 45 AS age, 200000 AS salary, "Manager" AS job, 1 AS status_code),
    STRUCT(2 AS emp_id, 102 AS dept_id, 42 AS age, 180000 AS salary, "Manager" AS job, NULL AS status_code),
    STRUCT(3 AS emp_id, 101 AS dept_id, 28 AS age, 150000 AS salary, "Manager" AS job, 2 AS status_code),
    STRUCT(4 AS emp_id, 102 AS dept_id, 25 AS age, 80000 AS salary,  "Analyst" AS job, 1 AS status_code),
    STRUCT(5 AS emp_id, 101 AS dept_id, 29 AS age, 70000 AS salary,  "Analyst" AS job, 2 AS status_code),
    STRUCT(6 AS emp_id, 102 AS dept_id, 37 AS age, 80000 AS salary,  "Analyst" AS job, NULL AS status_code)
  ]);
--
ARRAY<STRUCT<emp_id INT64,
             dept_id INT64,
             age INT64,
             salary INT64,
             job STRING,
             status_code INT64>>
[
  {2, 102, 42, 180000, "Manager", NULL},
  {4, 102, 25, 80000, "Analyst", 1},
  {6, 102, 37, 80000, "Analyst", NULL},
  {1, 101, 45, 200000, "Manager", 1},
  {3, 101, 28, 150000, "Manager", 2},
  {5, 101, 29, 70000, "Analyst", 2}
]
==

[prepare_database]
CREATE TABLE TestExamTableWithRowId AS
SELECT cast(1 as int64) as row_id,
       cast("Hansen" as string) as last_name,
       cast("P91" as string) as test_id,
       cast(510 as double) as test_score UNION ALL
SELECT 2, "Wang", "U25", 500 UNION ALL
SELECT 3, "Wang", "C83", 520 UNION ALL
SELECT 4, "Wang", "U25", 460 UNION ALL
SELECT 5, "Hansen", "C83", 420 UNION ALL
SELECT 6, "Hansen", "C83", 560 UNION ALL
SELECT 7, "Devi", "U25", 580 UNION ALL
SELECT 8, "Devi", "P91", 480 UNION ALL
SELECT 9, "Ivanov", "U25", 490 UNION ALL
SELECT 10, "Ivanov", "P91", 540 UNION ALL
SELECT 11, "Silva", "U25", 550
--
ARRAY<STRUCT<row_id INT64, last_name STRING, test_id STRING, test_score DOUBLE>>[
  {1, "Hansen", "P91", 510},
  {2, "Wang", "U25", 500},
  {3, "Wang", "C83", 520},
  {4, "Wang", "U25", 460},
  {5, "Hansen", "C83", 420},
  {6, "Hansen", "C83", 560},
  {7, "Devi", "U25", 580},
  {8, "Devi", "P91", 480},
  {9, "Ivanov", "U25", 490},
  {10, "Ivanov", "P91", 540},
  {11, "Silva", "U25", 550}
]
==

[prepare_database]
CREATE TEMP FUNCTION TimesTwo(arg1 INT64) AS (
  arg1 * 2
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING]
CREATE TEMP AGGREGATE FUNCTION CountStar() AS (
  COUNT(*)
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING]
CREATE TEMP AGGREGATE FUNCTION SumOfAggregateArgs(arg1 INT64) AS (
  SUM(arg1)
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING]
[required_features=AGGREGATE_FILTERING]
CREATE TEMP AGGREGATE FUNCTION SumArg1BiggerThanArg2(arg1 INT64, arg2 INT64) AS (
  SUM(arg1 WHERE arg1 > arg2)
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING]
[required_features=AGGREGATE_FILTERING]
CREATE TEMP AGGREGATE FUNCTION SumArg1BiggerThanArg2TimesTwo(arg1 INT64, arg2 INT64) AS (
  TimesTwo(SUM(arg1 WHERE arg1 > arg2))
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING]
[required_features=AGGREGATE_FILTERING,TEMPLATE_FUNCTIONS]
CREATE TEMP AGGREGATE FUNCTION TemplatedSumArg1BiggerThanArg2TimesTwo(arg1 ANY TYPE, arg2 ANY TYPE) AS (
  TimesTwo(SUM(arg1 WHERE arg1 > arg2))
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING]
[required_features=AGGREGATE_FILTERING]
CREATE TEMP AGGREGATE FUNCTION MaxMinusMin(arg1 INT64) AS (
  MAX(arg1) - MIN(arg1)
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING]
[required_features=AGGREGATE_FILTERING]
CREATE TEMP FUNCTION NullaryUdfContainingWhereFilterReturnsZero() AS (
  (SELECT COUNT(* WHERE false) FROM UNNEST([1]))
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING]
[required_features=AGGREGATE_FILTERING,TEMPLATE_FUNCTIONS]
CREATE TEMP FUNCTION TemplatedUdfContainingWhereFilterReturnsCount(arg ANY TYPE) AS (
  (SELECT COUNT(arg WHERE true) FROM UNNEST([1]))
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING]
[required_features=TABLE_VALUED_FUNCTIONS,CREATE_TABLE_FUNCTION,AGGREGATE_FILTERING]
CREATE TABLE FUNCTION NoArgumentTvfContainingFilterReturnsOne() AS (
  (SELECT COUNT(* WHERE x > 2) AS result FROM UNNEST([1,2,3]) AS x)
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING]
[required_features=TABLE_VALUED_FUNCTIONS,CREATE_TABLE_FUNCTION,AGGREGATE_FILTERING,TEMPLATE_FUNCTIONS]
CREATE TABLE FUNCTION TemplatedTvfContainingFilterReturnsCountStar(arg_t ANY TABLE) AS (
  SELECT COUNT(* WHERE true) AS result FROM arg_t
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
[required_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
CREATE TEMP FUNCTION NullaryUdfContainingHavingFilterReturnsOne() AS (
  (
    SELECT
      COUNT(* GROUP BY key HAVING SUM(value) = 2)
    FROM UNNEST([
      STRUCT(1 AS key, 2 AS value),
      STRUCT(2 AS key, 1 AS value),
      STRUCT(2 AS key, 0 AS value)
    ])
  )
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
[required_features=AGGREGATE_FILTERING,TEMPLATE_FUNCTIONS,MULTILEVEL_AGGREGATION]
CREATE TEMP FUNCTION TemplatedUdfContainingHavingFilterReturnsCount(arg ANY TYPE) AS (
  (
    SELECT
      COUNT(arg GROUP BY key HAVING SUM(value) = 2)
    FROM UNNEST([
      STRUCT(1 AS key, 2 AS value),
      STRUCT(2 AS key, 1 AS value)
    ])
  )
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
[required_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
CREATE TEMP AGGREGATE FUNCTION KeysWithPositiveSumOfValues(key INT64, value INT64) AS (
  ARRAY_AGG(key GROUP BY key HAVING SUM(value) > 0)
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
[required_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION,TEMPLATE_FUNCTIONS]
CREATE TEMP AGGREGATE FUNCTION TemplatedKeysWithPositiveSumOfValues(key ANY TYPE, value ANY TYPE) AS (
  ARRAY_AGG(key GROUP BY key HAVING SUM(value) > 0)
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
[required_features=TABLE_VALUED_FUNCTIONS,CREATE_TABLE_FUNCTION,AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
CREATE TABLE FUNCTION NoArgumentTvfContainingHavingFilterReturnsOne() AS (
  (
    SELECT
      COUNT(* GROUP BY key HAVING SUM(value) = 2) AS one
    FROM UNNEST([
      STRUCT(1 AS key, 2 AS value),
      STRUCT(2 AS key, 1 AS value)
    ])
  )
);
==
[prepare_database]
[prepare_database_additional_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
[required_features=TABLE_VALUED_FUNCTIONS,CREATE_TABLE_FUNCTION,TEMPLATE_FUNCTIONS,AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
CREATE TABLE FUNCTION TemplatedTvfContainingHavingFilterReturnsSumofSalaryValuesForEmployeesFiveAndSix(arg_t ANY TABLE) AS (
  (
    SELECT
      SUM(SUM(arg_t.salary) GROUP BY arg_t.emp_id HAVING arg_t.emp_id >= 5) AS sum_salary
    FROM arg_t
  )
);
==
# Filter is additional on top of the shared WHERE clause
[name=simple_filter]
[required_features=AGGREGATE_FILTERING]
SELECT
  dept_id,
  count(* WHERE job = "Analyst") AS cnt_star_analyst,
  count(salary WHERE job = "Analyst") AS cnt_analyst,

  count(* WHERE job = "Manager") AS cnt_star_mgr,
  count(salary WHERE job = "Manager") AS cnt_mgr,

  count(*) AS cnt_star,
  count(salary) AS cnt_salary,
FROM Employees
WHERE age < 40
GROUP BY dept_id
--
ARRAY<STRUCT<
        dept_id INT64,
        cnt_star_analyst INT64,
        cnt_analyst INT64,
        cnt_star_mgr INT64,
        cnt_mgr INT64,
        cnt_star INT64,
        cnt_salary INT64
      >>
[unknown order:
  {101, 1, 1, 1, 1, 2, 2},
  {102, 2, 2, 0, 0, 2, 2}
]
==

# Filter with multi-level aggregation
[name=filter_with_mla]
[required_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
SELECT
  SUM(AVG(salary WHERE age < 40) GROUP BY dept_id),
  SUM(AVG(salary WHERE age < 30) WHERE job = "Analyst" GROUP BY dept_id)
FROM Employees
--
ARRAY<STRUCT<DOUBLE, DOUBLE>>[{190000, 150000}]
==

# One of the groups results in zero rows passing the filter.
[required_features=AGGREGATE_FILTERING,ORDER_BY_IN_AGGREGATE]
[name=filter_with_order_by]
SELECT
  dept_id,
  ARRAY_AGG(emp_id ORDER BY salary DESC) AS unfiltered,
  ARRAY_AGG(emp_id WHERE salary > 100000 ORDER BY salary DESC) AS arr,
FROM Employees
WHERE age < 40
GROUP BY dept_id
--
ARRAY<STRUCT<dept_id INT64, unfiltered ARRAY<>, arr ARRAY<>>>[unknown order:
  {
    101,
    ARRAY<INT64>[known order:3, 5],
    ARRAY<INT64>[3]
  },
  {
    102,
    ARRAY<INT64>[unknown order:4, 6],
    ARRAY<INT64>(NULL)
  }
]
==

[required_features=AGGREGATE_FILTERING,NULL_HANDLING_MODIFIER_IN_AGGREGATE]
[name=filter_with_respect_nulls]
SELECT
  ARRAY_AGG(status_code) AS unfiltered,
  ARRAY_AGG(status_code RESPECT NULLS WHERE age < 40) AS codes,
  ARRAY_AGG(status_code IGNORE NULLS) AS codes_no_nulls,
FROM Employees
--
ARRAY<STRUCT<
        unfiltered ARRAY<>,
        codes ARRAY<>,
        codes_no_nulls ARRAY<>
      >>
[{
   ARRAY<INT64>[unknown order:1, 1, 2, NULL, NULL, 2],
   ARRAY<INT64>[unknown order:1, 2, NULL, 2],
   ARRAY<INT64>[unknown order:1, 1, 2, 2]
 }]
==

[required_features=AGGREGATE_FILTERING,HAVING_IN_AGGREGATE]
[name=filter_with_having_min_max]
SELECT
  dept_id,
  ARRAY_AGG(emp_id HAVING MIN age) AS unfiltered,
  ARRAY_AGG(emp_id WHERE salary > 100000 HAVING MIN age) AS codes,
FROM Employees
WHERE age < 40
GROUP BY dept_id
--
ARRAY<STRUCT<dept_id INT64, unfiltered ARRAY<>, codes ARRAY<>>>[unknown order:
  {101, ARRAY<INT64>[3], ARRAY<INT64>[3]},
  {102, ARRAY<INT64>[4], ARRAY<INT64>(NULL)}
]
==

[required_features=AGGREGATE_FILTERING,LIMIT_IN_AGGREGATE]
[name=filter_with_limit]
SELECT
  dept_id,
  ARRAY_AGG(emp_id LIMIT 3) AS unfiltered,
  ARRAY_AGG(emp_id WHERE job = "Manager" LIMIT 3) AS arr,
FROM Employees
WHERE age < 40
GROUP BY dept_id
--
ARRAY<STRUCT<dept_id INT64, unfiltered ARRAY<>, arr ARRAY<>>>[unknown order:
  {
    101,
    ARRAY<INT64>[unknown order:5, 3],
    ARRAY<INT64>[3]
  },
  {
    102,
    ARRAY<INT64>[unknown order:4, 6],
    ARRAY<INT64>(NULL)
  }
]
==

[required_features=AGGREGATE_FILTERING]
[name=filter_with_distinct]
SELECT
  dept_id,
  ARRAY_AGG(job) AS duplicated,
  ARRAY_AGG(DISTINCT job) AS unfiltered,
  ARRAY_AGG(DISTINCT job WHERE job = "Manager") AS arr,
FROM Employees
WHERE age < 40
GROUP BY dept_id
--
ARRAY<STRUCT<dept_id INT64, duplicated ARRAY<>, unfiltered ARRAY<>, arr ARRAY<>>>[unknown order:
  {
    101,
    ARRAY<STRING>[unknown order:"Analyst", "Manager"],
    ARRAY<STRING>[unknown order:"Analyst", "Manager"],
    ARRAY<STRING>["Manager"]
  },
  {
    102,
    ARRAY<STRING>[unknown order:"Analyst", "Analyst"],
    ARRAY<STRING>["Analyst"],
    ARRAY<STRING>(NULL)
  }
]
==

# Error: There's no way to escape this error: the filter needs to be evaluated
# to even tell if the row is going to count in the aggregation:
[name=error_in_filter]
SELECT
  dept_id,
  count(* WHERE 1.0/(emp_id - 1) > 0) AS cnt,
  max(salary) AS max_salary
FROM Employees
GROUP BY dept_id
--
ERROR: generic::out_of_range: division by zero: 1 / 0
==

# Error: There's no way to escape this calculation: the filter needs to be
# evaluated to even tell if the row is going to count in the aggregation.
# But we use SAFE_DIVIDE, so the query shouldn't fail.
[name=escaped_error_in_filter]
SELECT
  dept_id,
  count(* WHERE SAFE_DIVIDE(1.0, (emp_id - 1)) > 0) AS cnt,
  max(salary) AS max_salary
FROM Employees
GROUP BY dept_id
--
ARRAY<STRUCT<dept_id INT64, cnt INT64, max_salary INT64>>[unknown order:
  {101, 2, 200000},
  {102, 3, 180000}
]
==

[required_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
[name=filter_with_multilevel]
SELECT
  dept_id,
  ARRAY_AGG(MIN(emp_id) WHERE salary < 80000 GROUP BY job) AS arr,
FROM Employees
WHERE age < 40
GROUP BY dept_id
--
ARRAY<STRUCT<dept_id INT64, arr ARRAY<>>>[unknown order:
  {101, ARRAY<INT64>[5]},
  {102, ARRAY<INT64>(NULL)}
]
==


[required_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
[name=filter_on_inner_aggregate_in_multilevel]
SELECT
  dept_id,
  ARRAY_AGG(MIN(emp_id WHERE job = "Manager") GROUP BY job) AS arr,
FROM Employees
WHERE age < 40
GROUP BY dept_id
--
ARRAY<STRUCT<dept_id INT64, arr ARRAY<>>>[unknown order:
  {
    101,
    ARRAY<INT64>[unknown order:NULL, 3]
  },
  {102, ARRAY<INT64>[NULL]}
]
==

[name=filter_in_having_clause]
SELECT
  dept_id,
  ARRAY_AGG(emp_id) AS unfiltered,
FROM Employees
WHERE age < 40
GROUP BY dept_id
HAVING sum(salary WHERE status_code = 1) > 50000
--
ARRAY<STRUCT<dept_id INT64, unfiltered ARRAY<>>>[
  {
    102,
    ARRAY<INT64>[unknown order:4, 6]
  }
]
==

# Ensure the branch with an error does fail the query
[name=filter_with_conditional_evaluation_error_in_chosen_branch]
SELECT
  dept_id,
  IF (SUM(salary) < 0,
    [],
    ARRAY_AGG(emp_id WHERE salary < cast('xyz' AS INT64))) AS arr,
FROM Employees
WHERE age < 40
GROUP BY dept_id
--
ERROR: generic::out_of_range: Bad int64 value: xyz
==

# Ensure the branch with an error doesn't fail the query.
[required_features=AGGREGATE_FILTERING,ENFORCE_CONDITIONAL_EVALUATION]
[name=filter_with_conditional_evaluation_avoids_error_in_unchosen_branch]
SELECT
  dept_id,
  IF (SUM(salary) > 10000,
    ARRAY_AGG(emp_id WHERE salary < 100000),
    ARRAY_AGG(emp_id WHERE salary < cast('xyz' AS INT64))) AS arr,
FROM Employees
WHERE age < 40
GROUP BY dept_id
--
ARRAY<STRUCT<dept_id INT64, arr ARRAY<>>>[unknown order:
  {
    102,
    ARRAY<INT64>[unknown order:4, 6]
  },
  {101, ARRAY<INT64>[5]}
]
==

# MATCH_RECOGNIZE MEASURES add conjunction filters to aggregations:
# (NOT `$is_sentinel` AND CLASSIFIER() = '<referenced_var>')
[reserve_match_recognize]
[required_features=AGGREGATE_FILTERING,MATCH_RECOGNIZE,ORDER_BY_IN_AGGREGATE]
[name=filter_with_match_recognize_measure_containing_pattern_var_refs]
SELECT * FROM Employees MATCH_RECOGNIZE(
  ORDER BY emp_id
  MEASURES ARRAY_AGG(A.emp_id WHERE A.salary > 80000) AS m
  PATTERN (a+)
  DEFINE a AS true
)
--
ARRAY<STRUCT<m ARRAY<>>>[{ARRAY<INT64>[known order:1, 2, 3]}]
==

[name=filter_on_uda_1]
SELECT
  dept_id,
  CountStar(WHERE job = "Analyst"),
  SumOfAggregateArgs(age WHERE job = "Analyst"),
  MaxMinusMin(age WHERE salary > 70000)
FROM Employees
GROUP BY 1
ORDER BY 1, 2, 3, 4;
--
ARRAY<STRUCT<dept_id INT64, INT64, INT64, INT64>>[known order:
  {101, 1, 29, 17},
  {102, 2, 62, 17}
]
==

[name=filter_on_uda_2]
SELECT
  dept_id,
  CountStar(WHERE true),
  CountStar(WHERE false),
  CountStar(WHERE job = "Analyst"),
  CountStar(WHERE CAST(NULL as BOOL)),
FROM Employees
GROUP BY 1
ORDER BY 1, 2, 3, 4, 5;
--
ARRAY<STRUCT<dept_id INT64, INT64, INT64, INT64, INT64>>[known order:
  {101, 3, 0, 1, 0},
  {102, 3, 0, 2, 0}
]
==

[name=filter_on_uda_containing_filter_in_body]
SELECT
  dept_id,
  SumArg1BiggerThanArg2(salary, 75000 WHERE job = "Analyst"),
  SumArg1BiggerThanArg2TimesTwo(salary, 75000 WHERE job = "Analyst")
FROM Employees
GROUP BY 1
ORDER BY 1, 2, 3;
--
ARRAY<STRUCT<dept_id INT64, INT64, INT64>>[known order:
  {101, NULL, NULL},
  {102, 160000, 320000}
]
==

[name=filter_on_templated_uda_containing_filter_in_body]
[required_features=AGGREGATE_FILTERING,TEMPLATE_FUNCTIONS]
[skip_required_feature_integrity_check]
SELECT
  dept_id,
  TemplatedSumArg1BiggerThanArg2TimesTwo(salary, 75000 WHERE job = "Analyst")
FROM Employees
GROUP BY 1
ORDER BY 1, 2;
--
ARRAY<STRUCT<dept_id INT64, INT64>>[known order:{101, NULL}, {102, 320000}]
==

[name=filter_inside_udf]
[skip_required_feature_integrity_check]
SELECT NullaryUdfContainingWhereFilterReturnsZero()
--
ARRAY<STRUCT<INT64>>[{0}]
==

[name=filter_inside_templated_udf]
[required_features=AGGREGATE_FILTERING,TEMPLATE_FUNCTIONS]
[skip_required_feature_integrity_check]
SELECT TemplatedUdfContainingWhereFilterReturnsCount(1);
--
ARRAY<STRUCT<INT64>>[{1}]
==

[name=filter_inside_tvf]
[required_features=AGGREGATE_FILTERING,TABLE_VALUED_FUNCTIONS,CREATE_TABLE_FUNCTION]
[skip_required_feature_integrity_check]
SELECT * FROM NoArgumentTvfContainingFilterReturnsOne()
--
ARRAY<STRUCT<result INT64>>[{1}]
==

[name=filter_inside_templated_tvf]
[required_features=AGGREGATE_FILTERING,TABLE_VALUED_FUNCTIONS,TEMPLATE_FUNCTIONS,CREATE_TABLE_FUNCTION]
[skip_required_feature_integrity_check]
SELECT * FROM TemplatedTvfContainingFilterReturnsCountStar(TABLE Employees)
--
ARRAY<STRUCT<result INT64>>[{6}]
==

[name=having_filter]
[required_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
SELECT
  dept_id,
  SUM(COUNT(*) GROUP BY job HAVING job = "Manager"),
  SUM(COUNT(*) GROUP BY job HAVING AVG(salary) > 100000),
  SUM(COUNT(* WHERE age < 40) GROUP BY job HAVING AVG(salary) > 100000)
FROM Employees
GROUP BY 1
ORDER BY 1, 2, 3, 4;
--
ARRAY<STRUCT<dept_id INT64, INT64, INT64, INT64>>[known order:
  {101, 2, 2, 1},
  {102, 1, 1, 0}
]
==

[name=having_filter_with_aggregate_clauses]
[required_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION,ORDER_BY_IN_AGGREGATE]
SELECT
  dept_id,
  ARRAY_CONCAT_AGG(
    ARRAY_AGG(emp_id ORDER BY emp_id)
    GROUP BY job
    HAVING AVG(salary) > 100000
  )
FROM Employees
GROUP BY 1
ORDER BY 1
--
ARRAY<STRUCT<dept_id INT64, ARRAY<>>>[known order:
  {
    101,
    ARRAY<INT64>[known order:1, 3]
  },
  {102, ARRAY<INT64>[2]}
]
==

[name=having_filter_inside_udf]
[required_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
[skip_required_feature_integrity_check]
SELECT NullaryUdfContainingHavingFilterReturnsOne()
--
ARRAY<STRUCT<INT64>>[{1}]
==

[name=having_filter_inside_templated_udf]
[required_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION,TEMPLATE_FUNCTIONS]
[skip_required_feature_integrity_check]
SELECT TemplatedUdfContainingHavingFilterReturnsCount(x) FROM UNNEST([1, 2]) AS x;
--
ARRAY<STRUCT<INT64>>[unknown order:{1}, {1}]
==

[name=having_filter_inside_uda]
[required_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION]
[skip_required_feature_integrity_check]
SELECT
  KeysWithPositiveSumOfValues(key, value)
FROM UNNEST([
  STRUCT(1 AS key, -1 AS value), STRUCT(2 AS key, 1 AS value)
]);
--
ARRAY<STRUCT<ARRAY<>>>[{ARRAY<INT64>[2]}]
==

[name=having_filter_inside_templated_uda]
[required_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION,TEMPLATE_FUNCTIONS]
[skip_required_feature_integrity_check]
SELECT
  TemplatedKeysWithPositiveSumOfValues(key, value)
FROM UNNEST([
  STRUCT(1 AS key, -1 AS value), STRUCT(2 AS key, 1 AS value)
]);
--
ARRAY<STRUCT<ARRAY<>>>[{ARRAY<INT64>[2]}]
==

[name=having_filter_inside_tvf]
[required_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION,TABLE_VALUED_FUNCTIONS,CREATE_TABLE_FUNCTION]
[skip_required_feature_integrity_check]
SELECT * FROM NoArgumentTvfContainingHavingFilterReturnsOne()
--
ARRAY<STRUCT<one INT64>>[{1}]
==

[name=having_filter_inside_templated_tvf]
[required_features=AGGREGATE_FILTERING,MULTILEVEL_AGGREGATION,TABLE_VALUED_FUNCTIONS,CREATE_TABLE_FUNCTION,TEMPLATE_FUNCTIONS]
[skip_required_feature_integrity_check]
SELECT * FROM TemplatedTvfContainingHavingFilterReturnsSumofSalaryValuesForEmployeesFiveAndSix(TABLE Employees)
--
ARRAY<STRUCT<sum_salary INT64>>[{150000}]
